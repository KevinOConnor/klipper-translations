# CANBUS

Този документ описва поддръжката на CAN шината на Klipper.

## Хардуер на устройството

Понастоящем Klipper поддържа CAN на чипове stm32, SAME5x и rp2040. Освен това микроконтролерният чип трябва да е на платка, която има CAN приемо-предавател.

За да компилирате за CAN, стартирайте `make menuconfig` и изберете "CAN bus" като комуникационен интерфейс. Накрая компилирайте кода на микроконтролера и го прехвърлете на целевата платка.

## Хардуер на хоста

За да използвате CAN шина, е необходимо да разполагате с хост адаптер. Препоръчва се използването на "USB към CAN адаптер". Има много различни адаптери от USB към CAN, предлагани от различни производители. Когато избирате такъв, препоръчваме да проверите дали фърмуерът може да бъде актуализиран в него. (За съжаление, установихме, че някои USB адаптери работят с дефектен фърмуер и са блокирани, затова проверете преди покупка.) Търсете адаптери, които могат да стартират Klipper директно (в режим "USB към CAN мост") или които работят с фърмуера [candlelight firmware](https://github.com/candle-usb/candleLight_fw).

Необходимо е също така да се конфигурира хост операционната система за използване на адаптера. Обикновено това се прави чрез създаване на нов файл с име `/etc/network/interfaces.d/can0` със следното съдържание:

```
allow-hotplug can0
iface can0 can static
    bitrate 1000000
    up ip link set $IFACE txqueuelen 128
```

## Терминиращи резистори

Шината CAN трябва да има два 120-омови резистора между проводниците CANH и CANL. В идеалния случай по един резистор трябва да бъде разположен във всеки край на шината.

Имайте предвид, че някои устройства имат вграден 120-омов резистор, който не може да се отстрани лесно. Някои устройства изобщо не включват резистор. Други устройства имат механизъм за избор на резистор (обикновено чрез свързване на "джъмпер"). Не забравяйте да проверите схемите на всички устройства по шината CAN, за да се уверите, че в шината има два и само два 120-омови резистора.

За да проверите дали резисторите са правилни, можете да изключите захранването на принтера и да използвате мултиметър, за да проверите съпротивлението между проводниците CANH и CANL - при правилно свързана CAN шина той трябва да отчете ~60 ома.

## Намиране на canbus_uuid за нови микроконтролери

На всеки микроконтролер по шината CAN се присвоява уникален идентификатор въз основа на фабричния идентификатор на чипа, кодиран във всеки микроконтролер. За да откриете идентификатора на устройството на всеки микроконтролер, уверете се, че хардуерът е захранен и свързан правилно, и след това го стартирайте:

```
~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0
```

Ако бъдат открити неинициализирани CAN устройства, горната команда ще отчете следните редове:

```
Намерено canbus_uuid=11aa22bb33cc, Приложение: Klipper
```

Всяко устройство ще има уникален идентификатор. В горния пример `11aa22bb33cc` е "canbus_uuid" на микроконтролера.

Имайте предвид, че инструментът `canbus_query.py` ще докладва само за неинициализирани устройства - ако Klipper (или подобен инструмент) конфигурира устройството, то вече няма да се появява в списъка.

## Конфигуриране на Klipper

Актуализирайте Klipper [mcu configuration](Config_Reference.md#mcu), за да използвате CAN шината за комуникация с устройството - например:

```
[mcu my_can_mcu]
canbus_uuid: 11aa22bb33cc
```

## Режим на мост между USB и CAN шина

Някои микроконтролери поддържат избор на режим "USB to CAN bus bridge" (мост между USB и CAN шина) по време на "make menuconfig" на Klipper. Този режим може да позволи използването на микроконтролера едновременно като "адаптер от USB към CAN шина" и като възел на Klipper.

Когато Klipper използва този режим, микроконтролерът се появява като "USB CAN bus adapter" под Linux. Самият микропроцесор "Klipper bridge mcu" ще изглежда така, сякаш е на тази CAN шина - той може да бъде идентифициран чрез `canbus_query.py` и трябва да бъде конфигуриран като другите възли на Klipper с CAN шина.

Някои важни забележки при използването на този режим:

* Необходимо е да се конфигурира интерфейсът `can0` (или подобен) в Linux, за да се осъществи връзка с шината. Въпреки това скоростта на CAN шината в Linux и опциите за битово време на CAN шината се игнорират от Klipper. Понастоящем честотата на CAN шината се задава по време на "make menuconfig" и скоростта на шината, зададена в Linux, се игнорира.
* Всеки път, когато "bridge mcu" се нулира, Linux ще деактивира съответния интерфейс `can0`. За да се осигури правилна обработка на командите FIRMWARE_RESTART и RESTART, се препоръчва да се използва `allow-hotplug` във файла `/etc/network/interfaces.d/can0`. Например:

```
allow-hotplug can0
iface can0 can static
    bitrate 1000000
    up ip link set $IFACE txqueuelen 128
```

* "Мостовият микропроцесор" всъщност не е включен в шината CAN. Съобщенията към и от мостовия микропроцесор няма да се виждат от други адаптери, които може да са на CAN шината.
* Наличната широчина на честотната лента както за самия мостов микропроцесор, така и за всички устройства по шината CAN е ефективно ограничена от честотата на шината CAN. В резултат на това се препоръчва да се използва честота на CAN шината от 1000000, когато се използва "режим на мост от USB към CAN шина".

   Дори при честота на шината CAN 1000000 може да няма достатъчна широчина на честотната лента за провеждане на теста `SHAPER_CALIBRATE`, ако стъпковите устройства XY и акселерометърът комуникират чрез един интерфейс "USB към шина CAN".
* Платка с мост от USB към CAN няма да се появи като USB серийно устройство, няма да се появи при изпълнение на `ls /dev/serial/by-id` и не може да бъде конфигурирана във файла printer.cfg на Klipper с параметър `serial:`. Мостовата платка се появява като "USB CAN адаптер" и се конфигурира в printer.cfg като [CAN възел](#configuring-klipper).

## Съвети за отстраняване на неизправности

Вижте документа [Отстраняване на неизправности по шината CAN](CANBUS_Troubleshooting.md).
