# Протокол CANBUS

Този документ описва протокола, който Klipper използва за комуникация по [CAN bus](https://en.wikipedia.org/wiki/CAN_bus). Вижте <CANBUS.md> за информация относно конфигурирането на Klipper с CAN шина.

## Задаване на идентификатор на микроконтролер

Klipper използва само стандартни пакети на шината CAN 2.0A, които са ограничени до 8 байта данни и 11-битов идентификатор на шината CAN. За да се поддържа ефективна комуникация, на всеки микроконтролер по време на работа се присвоява уникален 1-байтов CAN bus nodeid (`canbus_nodeid`) за общия трафик от команди и отговори на Klipper. Командните съобщения на Klipper, които се изпращат от хоста към микроконтролера, използват идентификатора на CAN шината `canbus_nodeid * 2 + 256`, докато съобщенията за отговор на Klipper от микроконтролера към хоста използват `canbus_nodeid * 2 + 256 + 1`.

Всеки микроконтролер има фабрично зададен уникален идентификатор на чипа, който се използва при присвояването на идентификатора. Този идентификатор може да надхвърли дължината на един CAN пакет, така че се използва хеш функция за генериране на уникален 6-байтов идентификатор (`canbus_uuid`) от фабричния идентификатор.

## Съобщения на администратора

Съобщенията на администратора се използват за присвояване на идентификатори. Административните съобщения, изпратени от хоста към микроконтролера, използват идентификатора на CAN шината `0x3f0`, а съобщенията, изпратени от микроконтролера към хоста, използват идентификатора на CAN шината `0x3f1`. Всички микроконтролери слушат съобщения на id `0x3f0`; този id може да се разглежда като "излъчващ адрес".

### CMD_QUERY_UNASSIGNED съобщение

Тази команда прави справка за всички микроконтролери, на които все още не е присвоен `canbus_nodeid`. Неприсвоените микроконтролери ще отговорят със съобщение за отговор RESP_NEED_NODEID.

Форматът на съобщението CMD_QUERY_UNASSIGNED е: `<1 байт message_id = 0x00>`

### Съобщение CMD_SET_KLIPPER_NODEID

Тази команда задава `canbus_nodeid` на микроконтролера с даден `canbus_uuid`.

Форматът на съобщението CMD_SET_KLIPPER_NODEID е: `<1-байтов message_id = 0x01><6-байтов canbus_uuid><1-байтов canbus_nodeid>`

### Съобщение RESP_NEED_NODEID

Форматът на съобщението RESP_NEED_NODEID е: `<1-байтов message_id = 0x20><6-байтов canbus_uuid><1-байтов set_klipper_nodeid = 0x01>`

## Пакети данни

Микроконтролерът, на който е присвоен nodeid чрез командата CMD_SET_KLIPPER_NODEID, може да изпраща и получава пакети с данни.

Пакетните данни в съобщенията, използващи идентификатора на шината CAN за приемане на възела (`canbus_nodeid * 2 + 256`), просто се добавят към буфер и когато се открие пълно съобщение [mcu protocol message](Protocol.md), съдържанието му се анализира и обработва. Данните се обработват като поток от байтове - няма изискване началото на блок със съобщение на Klipper да съвпада с началото на пакет на шина CAN.

По подобен начин отговорите на съобщенията на протокола mcu се изпращат от микроконтролера към хоста чрез копиране на данните на съобщението в един или повече пакети с идентификатора на предавателната шина CAN на възела (`canbus_nodeid * 2 + 256 + 1`).
