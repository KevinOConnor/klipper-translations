# Endstop phase

Този документ описва системата за крайно спиране с регулиране на фазата на стъпковия механизъм на Klipper. Тази функционалност може да подобри точността на традиционните крайни спиращи превключватели. Тя е най-полезна, когато се използва драйвер за стъпков двигател Trinamic, който има конфигурация по време на работа.

Типичният краен прекъсвач има точност от около 100 микрона. (Всеки път, когато дадена ос се насочва, превключвателят може да се задейства малко по-рано или малко по-късно.) Въпреки че това е сравнително малка грешка, тя може да доведе до нежелани артефакти. По-специално, това позиционно отклонение може да се забележи при отпечатването на първия слой на обекта. За разлика от тях типичните стъпкови двигатели могат да постигнат значително по-висока точност.

Механизмът за крайно спиране с регулиране на фазата на стъпката може да използва прецизността на стъпковите двигатели, за да подобри прецизността на крайните спиращи превключватели. Стъпковият двигател се движи, като преминава през поредица от фази, докато завърши четири "пълни стъпки". Така че стъпков двигател, използващ 16 микростъпки, ще има 64 фази и при движение в положителна посока ще преминава през фази: 0, 1, 2, ... 61, 62, 63, 0, 1, 2 и т.н. Изключително важно е, че когато стъпковият двигател е в определена позиция на линейната релса, той винаги трябва да е в една и съща фаза на стъпката. По този начин, когато каретка задейства превключвателя за крайно спиране, стъпковият двигател, управляващ тази каретка, трябва винаги да е в същата фаза на стъпковия двигател. Системата за фаза на крайния ограничител на Klipper комбинира фазата на стъпковия механизъм със задействането на крайния ограничител, за да подобри точността на крайния ограничител.

За да се използва тази функционалност, е необходимо да може да се определи фазата на стъпковия двигател. Ако се използват драйвери Trinamic TMC2130, TMC2208, TMC2224 или TMC2660 в режим на конфигурация по време на работа (т.е. не в самостоятелен режим), Klipper може да поиска фазата на стъпковия двигател от драйвера. (Възможно е тази система да се използва и за традиционните стъпкови драйвери, ако може надеждно да се нулират стъпковите драйвери - вижте по-долу за подробности.)

## Калибриране на крайните спирачни фази

Ако използвате драйвери за стъпкови двигатели Trinamic с конфигурация по време на работа, можете да калибрирате фазите за крайно спиране, като използвате командата ENDSTOP_PHASE_CALIBRATE. Започнете, като добавите следното във файла за конфигуриране:

```
[endstop_phase]
```

След това рестартирайте принтера и изпълнете команда `G28`, последвана от команда `ENDSTOP_PHASE_CALIBRATE`. След това преместете главата на инструмента на ново място и изпълнете отново командата `G28`. Опитайте да преместите главата на инструмента на няколко различни места и да стартирате отново `G28` от всяка позиция. Изпълнете поне пет команди `G28`.

След извършване на горните действия командата `ENDSTOP_PHASE_CALIBRATE` често ще отчете същата (или почти същата) фаза за стъпковия механизъм. Тази фаза може да бъде записана във файла за конфигуриране, така че всички бъдещи команди на G28 да използват тази фаза. (Така че при бъдещи операции по навигиране Klipper ще получи една и съща позиция, дори ако крайната спирка се задейства малко по-рано или малко по-късно.)

За да запазите крайната фаза на спиране за конкретен стъпков двигател, изпълнете нещо подобно на следното:

```
ENDSTOP_PHASE_CALIBRATE STEPPER=stepper_z
```

Изпълнете горното за всички стъпала, които искате да запазите. Обикновено това се използва за stepper_z за картезиански и корексиални принтери и за stepper_a, stepper_b и stepper_c за делта принтери. Накрая изпълнете следното, за да актуализирате конфигурационния файл с данните:

```
SAVE_CONFIG
```

### Допълнителни бележки

* Тази функция е най-полезна при делта-принтерите и при Z-крайната точка на картезианските/корекционните принтери. Възможно е тази функция да се използва за XY крайните ограничители на картезианските принтери, но това не е особено полезно, тъй като малка грешка в позицията на X/Y крайния ограничител е малко вероятно да повлияе на качеството на печат. Не е валидно да се използва тази функция за крайните ограничители XY на корексиални принтери (тъй като позицията XY не се определя от един стъпков механизъм при корексиалната кинематика). Не е валидно да се използва тази функция за принтер, използващ "probe:z_virtual_endstop" Z краен ограничител (тъй като фазата на стъпката е стабилна само ако крайният ограничител е на статично място върху релса).
* След калибрирането на фазата на крайния ограничител, ако по-късно крайният ограничител бъде преместен или регулиран, ще бъде необходимо да се калибрира отново крайният ограничител. Премахнете данните за калибриране от конфигурационния файл и изпълнете отново горните стъпки.
* За да може да се използва тази система, крайният ограничител трябва да бъде достатъчно точен, за да определи позицията на стъпковия механизъм в рамките на две "пълни стъпки". Така например, ако стъпковият механизъм използва 16 микростъпки с разстояние между стъпките 0,005 mm, крайният ограничител трябва да има точност най-малко 0,160 mm. Ако се получават съобщения за грешка от типа "Endstop stepper_z incorrect phase", това може да се дължи на крайния ограничител, който не е достатъчно точен. Ако повторното калибриране не помогне, забранете настройките на фазата на ендстопа, като ги премахнете от файла за конфигуриране.
* Ако се използва традиционна ос Z, управлявана от стъпков механизъм (като при картезиански или корексиален принтер), заедно с традиционни винтове за изравняване на леглото, тогава е възможно също така да се използва тази система, за да се организира всеки печатен слой да се извършва на границата на "пълна стъпка". За да активирате тази функция, уверете се, че G-Code слайсерът е конфигуриран с височина на слоя, която е кратна на "пълна стъпка", ръчно активирайте опцията endstop_align_zero в секцията за конфигуриране endstop_phase (вижте [config reference](Config_Reference.md#endstop_phase) за повече подробности) и след това отново нивелирайте винтовете на леглото.
* Възможно е тази система да се използва с традиционни (нетринамови) драйвери за стъпкови двигатели. За целта обаче е необходимо да се уверите, че драйверите на стъпковите двигатели се нулират при всяко нулиране на микроконтролера. (Ако двете устройства се нулират винаги заедно, Klipper може да определи фазата на стъпковия двигател, като проследи общия брой стъпки, на които е дал команда на стъпковия двигател да се движи.) Понастоящем единственият начин да се направи това надеждно е, ако микроконтролерът и драйверите на стъпковия двигател се захранват единствено от USB и това USB захранване се осигурява от хост, работещ на Raspberry Pi. В тази ситуация може да се зададе конфигурация на mcu с "restart_method: rpi_usb" - тази опция ще направи така, че микроконтролерът винаги да се нулира чрез нулиране на USB захранването, което ще направи така, че и микроконтролерът, и драйверите на стъпковия двигател да се нулират заедно. Ако се използва този механизъм, ще трябва ръчно да се конфигурират секциите на конфигурацията "trigger_phase" (за подробности вижте [config reference](Config_Reference.md#endstop_phase)).
