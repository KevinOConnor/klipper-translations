# Изключване на обекти

The `[exclude_object]` module allows Klipper to exclude objects while a print is in progress. To enable this feature include an [exclude_object config
section](Config_Reference.md#exclude_object) (also see the [command
reference](G-Codes.md#exclude-object) and [sample-macros.cfg](../config/sample-macros.cfg) file for a Marlin/RepRapFirmware compatible M486 G-Code macro.)

За разлика от други опции за фърмуер на 3D принтери, принтерът, работещ с Klipper, използва набор от компоненти и потребителите имат много възможности за избор. Ето защо, за да се осигури последователен потребителски опит, модулът `[exclude_object]` ще създаде своеобразен договор или API. Договорът обхваща съдържанието на файла gcode, начина на управление на вътрешното състояние на модула и начина, по който това състояние се предоставя на клиентите.

## Преглед на работния процес

Типичен работен процес за отпечатване на файл може да изглежда по следния начин:

1. Рязането е завършено и файлът е качен за печат. По време на качването файлът се обработва и към него се добавят маркери `[exclude_object]`. Алтернативно, нарязващите устройства могат да бъдат конфигурирани да подготвят маркери за изключване на обекти самостоятелно или в собствена стъпка за предварителна обработка.
1. Когато започне отпечатването, Klipper ще нулира `[exclude_object]` [статус](Status_Reference.md#exclude_object).
1. Когато Klipper обработи блока `EXCLUDE_OBJECT_DEFINE`, той ще актуализира състоянието с известните обекти и ще го предаде на клиентите.
1. Клиентът може да използва тази информация, за да представи потребителски интерфейс на потребителя, така че да може да се проследява напредъкът. Klipper ще актуализира състоянието, за да включи обекта, който се отпечатва в момента и който клиентът може да използва за целите на показването.
1. Ако потребителят поиска даден обект да бъде отменен, клиентът ще издаде на Klipper команда `EXCLUDE_OBJECT NAME=<name>`.
1. Когато Klipper обработи командата, той ще добави обекта към списъка с изключени обекти и ще актуализира състоянието на клиента.
1. Клиентът ще получи актуализираното състояние от Klipper и ще може да използва тази информация, за да отрази състоянието на обекта в потребителския интерфейс.
1. Когато отпечатването приключи, статусът `[exclude_object]` ще продължи да бъде наличен, докато друго действие не го нулира.

## Файлът GCode

Специализираната обработка на gcode, необходима за поддържане на изключването на обекти, не се вписва в основните цели на дизайна на Klipper. Поради това този модул изисква файлът да бъде обработен, преди да бъде изпратен на Klipper за печат. Използването на скрипт за последваща обработка в слайсъра или обработката на файла от междинния софтуер при качване са две възможности за подготовка на файла за Klipper. Референтен скрипт за последваща обработка е наличен както като изпълним файл, така и като библиотека на Python, вижте [cancelobject-preprocessor](https://github.com/kageurufu/cancelobject-preprocessor).

### Дефиниции на обекти

Командата `EXCLUDE_OBJECT_DEFINE` се използва за предоставяне на обобщение на всеки обект в gcode файла, което да бъде отпечатано. Осигурява обобщение на даден обект във файла. Не е необходимо обектите да бъдат дефинирани, за да могат да бъдат препращани от други команди. Основната цел на тази команда е да предостави информация на потребителския интерфейс, без да е необходимо да се анализира целият gcode файл.

Дефинициите на обектите са именувани, за да могат потребителите лесно да изберат обект, който да бъде изключен, и могат да бъдат предоставени допълнителни метаданни, за да се даде възможност за графично показване на анулирането. Понастоящем дефинираните метаданни включват координата `CENTER` X,Y и списък `POLYGON` от точки X,Y, представляващи минимален контур на обекта. Това може да бъде проста ограничаваща кутия или сложен корпус за показване на по-подробни визуализации на отпечатаните обекти. Особено когато gcode файловете включват множество части с припокриващи се ограничителни области, централните точки стават трудни за визуално разграничаване. `POLYGONS` трябва да бъде json-съвместим масив от кортежи с точки `[X,Y]` без бели полета. Допълнителните параметри се записват като низове в дефиницията на обекта и се предоставят в актуализациите на състоянието.

`EXCLUDE_OBJECT_DEFINE NAME=calibration_pyramid CENTER=50,50 POLYGON=[[40,40],[50,60],[60,40]]`

All available G-Code commands are documented in the [G-Code
Reference](./G-Codes.md#excludeobject)

## Информация за състоянието

The state of this module is provided to clients by the [exclude_object
status](Status_Reference.md#exclude_object).

Състоянието се нулира, когато:

- Фърмуерът на Klipper се рестартира.
- Налице е нулиране на `[virtual_sdcard]`. Забележително е, че тя се нулира от Klipper в началото на печат.
- Когато е издадена команда `EXCLUDE_OBJECT_DEFINE RESET=1`.

Списъкът на дефинираните обекти е представен в полето за състояние `exclude_object.objects`. В един добре дефиниран gcode файл това ще бъде направено с командите `EXCLUDE_OBJECT_DEFINE` в началото на файла. Това ще предостави на клиентите имената и координатите на обектите, така че потребителският интерфейс да може да осигури графично представяне на обектите, ако е необходимо.

С напредването на отпечатването полето за състояние `exclude_object.current_object` ще се актуализира, тъй като Klipper обработва командите `EXCLUDE_OBJECT_START` и `EXCLUDE_OBJECT_END`. Полето `current_object` ще бъде зададено, дори ако обектът е бил изключен. Неопределените обекти, маркирани с `EXCLUDE_OBJECT_START`, ще бъдат добавени към известните обекти, за да подпомогнат подсказването на потребителския интерфейс, без никакви допълнителни метаданни.

Когато се издават команди `EXCLUDE_OBJECT`, списъкът на изключените обекти се предоставя в масива `exclude_object.excluded_objects`. Тъй като Klipper гледа напред, за да обработи предстоящия gcode, може да има забавяне между момента на издаване на командата и момента на актуализиране на състоянието.
