# Кинематика

Този документ съдържа преглед на начина, по който Klipper реализира движението на робота (неговата [кинематика](https://en.wikipedia.org/wiki/Kinematics)). Съдържанието може да представлява интерес както за разработчици, които се интересуват от работа по софтуера Klipper, така и за потребители, които се интересуват от по-добро разбиране на механиката на своите машини.

## Ускорение

Klipper прилага схема за постоянно ускорение при всяка промяна на скоростта на печатащата глава - скоростта се променя постепенно до новата скорост, вместо да се променя внезапно. Klipper винаги налага ускорение между главата на инструмента и печата. Нишката, напускаща екструдера, може да бъде доста крехка - бързите тласъци и/или промените в потока на екструдера водят до лошо качество и лоша адхезия на леглото. Дори когато не се екструдира, ако печатащата глава е на едно и също ниво с отпечатъка, бързото раздвижване на главата може да доведе до прекъсване на наскоро нанесения филамент. Ограничаването на промените в скоростта на печатащата глава (спрямо отпечатъка) намалява рисковете от прекъсване на отпечатъка.

Важно е също така да се ограничи ускорението, така че стъпковите двигатели да не прескачат и да не натоварват прекомерно машината. Klipper ограничава въртящия момент на всеки стъпков двигател чрез ограничаване на ускорението на печатащата глава. Налагането на ускорение на печатащата глава естествено ограничава и въртящия момент на стъпките, които движат печатащата глава (обратното не винаги е вярно).

Klipper реализира постоянно ускорение. Ключовата формула за постоянно ускорение е:

```
velocity(time) = start_velocity + accel*time
```

## Трапецовиден генератор

Klipper използва традиционен "трапецовиден генератор", за да моделира движението на всеки ход - всеки ход има начална скорост, ускорява се до скорост на движение с постоянно ускорение, движи се с постоянна скорост и след това се забавя до крайната скорост с постоянно ускорение.

![trapezoid](img/trapezoid.svg.png)

Нарича се "трапецовиден генератор", защото диаграмата на скоростта на движението прилича на трапец.

Крейсерската скорост винаги е по-голяма или равна както на началната, така и на крайната скорост. Фазата на ускоряване може да бъде с нулева продължителност (ако началната скорост е равна на крайната скорост), фазата на движение може да бъде с нулева продължителност (ако движението започва да намалява скоростта веднага след ускоряването) и/или фазата на намаляване на скоростта може да бъде с нулева продължителност (ако крайната скорост е равна на крайната скорост).

![trapezoids](img/trapezoids.svg.png)

## Поглед напред

Системата "look-ahead" се използва за определяне на скоростта на завиване между отделните движения.

Разгледайте следните две движения, намиращи се в равнината XY:

![corner](img/corner.svg.png)

В горната ситуация е възможно да се намали напълно скоростта след първия ход и след това да се ускори напълно в началото на следващия ход, но това не е идеално, тъй като цялото това ускоряване и намаляване на скоростта ще увеличи значително времето за печат, а честите промени в потока на екструдера ще доведат до лошо качество на печата.

За да се справи с това, механизмът "look-ahead" поставя на опашка няколко входящи хода и анализира ъглите между ходовете, за да определи разумната скорост, която може да се получи по време на "пресечната точка" между два хода. Ако следващият ход е почти в същата посока, тогава главата трябва само да намали малко скоростта (ако изобщо има такава).

![lookahead](img/lookahead.svg.png)

Ако обаче следващото движение образува остър ъгъл (главата ще се движи в почти обратна посока при следващото движение), тогава е позволена само малка скорост на кръстовището.

![lookahead](img/lookahead-slow.svg.png)

Скоростите на кръстовището се определят с помощта на "приблизително центростремително ускорение". Най-доброто [описано от автора](https://onehossshay.wordpress.com/2011/09/24/improving_grbl_cornering_algorithm/). В Klipper обаче скоростите на кръстовищата се конфигурират чрез задаване на желаната скорост, която трябва да има ъгъл от 90° ("квадратна ъглова скорост"), а скоростите на кръстовищата за други ъгли се получават от нея.

Ключова формула за прогнозиране:

```
end_velocity^2 = start_velocity^2 + 2*accel*move_distance
```

### Minimum cruise ratio

Klipper също така прилага механизъм за изглаждане на движенията при кратки "зигзагообразни" движения. Разгледайте следните движения:

![zigzag](img/zigzag.svg.png)

В горния случай честите промени от ускоряване към забавяне могат да предизвикат вибрации на машината, което причинява напрежение на машината и увеличава шума. Klipper прилага механизъм, който гарантира, че между ускоряването и намаляването на скоростта винаги има известно движение при крейсерска скорост. Това се постига чрез намаляване на максималната скорост на някои движения (или поредица от движения), за да се осигури минимално разстояние, изминато със скорост на движение спрямо разстоянието, изминато по време на ускорението и забавянето.

Klipper реализира тази функция чрез проследяване както на обикновеното ускорение на движението, така и на виртуалната скорост "от ускорение до забавяне":

![smoothed](img/smoothed.svg.png)

По-конкретно, кодът изчислява каква би била скоростта на всяко движение, ако то се ограничаваше до тази виртуална скорост на "ускорение към забавяне". На горната снимка прекъснатите сиви линии представляват тази виртуална скорост на ускорение за първия ход. Ако ходът не може да достигне пълната си скорост на движение, използвайки тази виртуална скорост на ускорение, тогава неговата максимална скорост се намалява до максималната скорост, която може да достигне при тази виртуална скорост на ускорение.

За повечето ходове границата ще бъде на или над съществуващите граници на хода и няма да предизвика промяна в поведението. За кратки зигзагообразни ходове обаче тази граница намалява максималната скорост. Обърнете внимание, че то не променя действителното ускорение в рамките на хода - ходът продължава да използва нормалната схема на ускорение до коригираната максимална скорост.

## Генериране на стъпки

След като процесът на разглеждане приключи, движението на печатащата глава за дадения ход е напълно известно (време, начална позиция, крайна позиция, скорост във всяка точка) и е възможно да се генерират времената на стъпките за хода. Този процес се извършва в рамките на "кинематичните класове" в кода на Klipper. Извън тези кинематични класове всичко се проследява в милиметри, секунди и в декартово координатно пространство. Задачата на кинематичните класове е да преобразуват тази обща координатна система в хардуерните особености на конкретния принтер.

Klipper използва [итеративен солвър](https://en.wikipedia.org/wiki/Root-finding_algorithm), за да генерира времената на стъпките за всеки стъпков механизъм. Кодът съдържа формулите за изчисляване на идеалните картезиански координати на главата във всеки момент от време и кинематичните формули за изчисляване на идеалните позиции на стъпковия механизъм въз основа на тези картезиански координати. С тези формули Klipper може да определи идеалното време, в което стъпковият механизъм трябва да се намира във всяка позиция на стъпката. След това дадените стъпки се планират в тези изчислени времена.

Основната формула за определяне на разстоянието, което трябва да измине едно движение при постоянно ускорение, е:

```
move_distance = (start_velocity + .5 * accel * move_time) * move_time
```

а ключовата формула за движение с постоянна скорост е:

```
move_distance = cruise_velocity * move_time
```

Основните формули за определяне на картезианската координата на даден ход при зададено разстояние на движение са:

```
cartesian_x_position = start_x + move_distance * total_x_movement / total_movement
cartesian_y_position = start_y + move_distance * total_y_movement / total_movement
cartesian_z_position = start_z + move_distance * total_z_movement / total_movement
```

### Картезиански роботи

Генерирането на стъпки за картезиански принтери е най-простият случай. Движението по всяка ос е пряко свързано с движението в картезианското пространство.

Основни формули:

```
stepper_x_position = cartesian_x_position
stepper_y_position = cartesian_y_position
stepper_z_position = cartesian_z_position
```

### Роботи CoreXY

Генерирането на стъпки в машина CoreXY е само малко по-сложно от основните картезиански роботи. Основните формули са:

```
stepper_a_position = cartesian_x_position + cartesian_y_position
stepper_b_position = cartesian_x_position - cartesian_y_position
stepper_z_position = cartesian_z_position
```

### Роботи Delta

Генерирането на стъпки при делта робот се основава на теоремата на Питагор:

```
stepper_position = (sqrt(arm_length^2
                         - (cartesian_x_position - tower_x_position)^2
                         - (cartesian_y_position - tower_y_position)^2)
                    + cartesian_z_position)
```

### Граници на ускорението на стъпковия двигател

При делтакинематиката е възможно движение, което се ускорява в картезианското пространство, да изисква ускорение на определен стъпков двигател, по-голямо от ускорението на движението. Това може да се случи, когато стъпковото рамо е по-скоро хоризонтално, отколкото вертикално, и линията на движение преминава близо до кулата на този стъпков двигател. Въпреки че тези движения могат да изискват ускорение на стъпковия двигател, по-голямо от максималното конфигурирано ускорение на движение на принтера, ефективната маса, преместена от този стъпков двигател, ще бъде по-малка. По този начин по-голямото ускорение на стъпковия двигател не води до значително по-голям въртящ момент на стъпковия двигател и поради това се счита за безвредно.

Въпреки това, за да се избегнат екстремни случаи, Klipper налага максимален таван на ускорението на стъпковия механизъм, който е три пъти по-голям от конфигурираното максимално ускорение на движение на принтера. (По същия начин максималната скорост на стъпковия механизъм е ограничена до три пъти максималната скорост на движение.) За да се наложи това ограничение, движенията в крайния край на обвивката за изграждане (където рамото на стъпковия механизъм може да е почти хоризонтално) ще имат по-ниско максимално ускорение и скорост.

### Кинематика на екструдера

Klipper имплементира движението на екструдера в свой собствен кинематичен клас. Тъй като времето и скоростта на всяко движение на печатащата глава са напълно известни за всяко движение, е възможно да се изчислят времената на стъпките за екструдера независимо от изчисленията на времената на стъпките на движението на печатащата глава.

Основното движение на екструдера е лесно за изчисляване. Генерирането на времето на стъпката използва същите формули, които се използват при картечните роботи:

```
stepper_position = requested_e_position
```

### Pressure advance

Експериментите показват, че е възможно да се подобри моделирането на екструдера отвъд основната формула на екструдера. В идеалния случай с напредването на екструдерния ход трябва да се отлага един и същ обем нишки във всяка точка по хода на движението и да няма обем, който да се екструдира след хода. За съжаление, често се случва да се окаже, че основните формули за екструдиране водят до излизане на твърде малко филамент от екструдера в началото на екструзионните ходове и до екструдиране на излишен филамент след края на екструдирането. Това често се нарича "изстиване".

![ooze](img/ooze.svg.png)

Системата "аванс на налягането" се опитва да отчете това, като използва различен модел за екструдера. Вместо наивно да вярва, че всеки mm^3 нишка, подадена в екструдера, ще доведе до незабавно излизане на това количество mm^3 от екструдера, тя използва модел, основан на налягането. Налягането се увеличава, когато нишката се вкарва в екструдера (както е в [закона на Хук](https://en.wikipedia.org/wiki/Hooke%27s_law)), а налягането, необходимо за екструдиране, се определя от скоростта на потока през отвора на дюзата (както е в [закона на Поазюл](https://en.wikipedia.org/wiki/Poiseuille_law)). Основната идея е, че връзката между нишката, налягането и дебита може да се моделира с помощта на линеен коефициент:

```
pa_position = nominal_position + pressure_advance_coefficient * nominal_velocity
```

Вижте документа [pressure advance](Pressure_Advance.md) за информация относно намирането на този коефициент на аванс на налягането.

Основната формула за увеличаване на налягането може да доведе до внезапни промени в скоростта на двигателя на екструдера. Klipper прилага "изглаждане" на движението на екструдера, за да избегне това.

![pressure-advance](img/pressure-velocity.png)

Горната графика показва пример за два екструзионни хода с ненулева ъглова скорост между тях. Обърнете внимание, че системата за авансиране под налягане води до избутване на допълнителна нишка в екструдера по време на ускорението. Колкото по-висок е желаният дебит на нишката, толкова повече нишка трябва да се вкара по време на ускорението, за да се отчете налягането. По време на забавянето на главата допълнителната нишка се прибира (екструдерът ще има отрицателна скорост).

"Изглаждането" се осъществява с помощта на среднопретеглена стойност на позицията на екструдера за малък период от време (както е посочено в конфигурационния параметър `pressure_advance_smooth_time`). Това осредняване може да обхваща няколко движения на g-кода. Обърнете внимание на това, че двигателят на екструдера ще започне да се движи преди номиналното начало на първия екструдиращ ход и ще продължи да се движи след номиналния край на последния екструдиращ ход.

Ключова формула за "изгладен аванс на налягането":

```
smooth_pa_position(t) =
    ( definitive_integral(pa_position(x) * (smooth_time/2 - abs(t - x)) * dx,
                          from=t-smooth_time/2, to=t+smooth_time/2)
     / (smooth_time/2)^2 )
```
