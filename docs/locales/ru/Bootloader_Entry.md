# Запись в загрузчик

Klipper можно дать команду перезагрузиться в [Bootloader](Bootloaders.md) одним из следующих способов:

## Запрашиваю загрузчик

### Виртуальный серийный

Если используется виртуальный (USB-ACM) последовательный порт, импульс DTR на скорости 1200 бод запросит загрузчик.

#### Python (с использованием `flash_usb`)

Чтобы войти в загрузчик с помощью python (используя `flash_usb`):

```shell
> cd klipper/scripts

> python3 -c 'import flash_usb as u; u.enter_bootloader("<DEVICE>")'

Entering bootloader on <DEVICE>
```

Где `<DEVICE>` - это ваше последовательное устройство, например `/dev/serial.by-id/usb-Klipper[...]` или `/dev/ttyACM0`

Обратите внимание, что в случае неудачи не будет выведено никаких результатов, а об успехе будет свидетельствовать печать `Entering bootloader on <DEVICE>`.

#### Picocom

```shell
picocom -b 1200 <Устройство>
<Ctrl-A><Ctrl-P>
```

Где `<DEVICE>` - это ваше последовательное устройство, например `/dev/serial.by-id/usb-Klipper[...]` или `/dev/ttyACM0`

`<Ctrl-A><Ctrl-P>` означает удерживание `Ctrl`, нажатие и отпускание `a`, нажатие и отпускание `p`, затем отпускание `Ctrl`

### Физическая серия

Если на MCU используется физический последовательный порт (даже если для подключения к нему используется последовательный USB-адаптер), отправьте строку `<SPACE><FS><SPACE>Запрос последовательного загрузчика!!<SPACE>~`.

`<SPACE>` - это буквенный пробел ASCII, 0x20.

`<FS>` - это разделитель файлов ASCII, 0x1c.

Обратите внимание, что это не является корректным сообщением согласно [MCU протокола](Protocol.md#micro-controller-interface), но символы синхронизации (`~`) по-прежнему соблюдаются.

Поскольку это сообщение должно быть единственным в "блоке", в котором оно получено, добавление дополнительного символа синхронизации может повысить надежность, если ранее к последовательному порту обращались другие инструменты.

#### Shell

```shell
stty <BAUD> < /dev/<DEVICE>
echo $'~ \x1c Запрос последовательного загрузчика!! ~' >> /dev/<DEVICE>
```

Где `<DEVICE>` - это ваш последовательный порт, например `/dev/ttyS0`, или `/dev/serial/by-id/gpio-serial2`, и

`<BAUD>` - это скорость передачи данных последовательного порта, например `115200`.

### CANBUS

Если используется CANBUS, специальное сообщение [сообщение администратора](CANBUS_protocol.md#admin-messages) запросит загрузчик. Это сообщение будет принято, даже если устройство уже имеет nodeid, а также будет обработано, если mcu выключен.

Этот метод также применим к устройствам, работающим в режиме [CANBridge](CANBUS.md#usb-to-can-bus-bridge-mode).

#### Katapult's flashtool.py

```shell
python3 ./katapult/scripts/flashtool.py -i <CAN_IFACE> -u <UUID> -r
```

Где `<CAN_IFACE>` - используемый интерфейс can. Если используется `can0`, то и `-i`, и `<CAN_IFACE>` могут быть опущены.

`<UUID>` - это UUID вашего CAN-устройства.

Информацию о поиске CAN UUID ваших устройств смотрите в [CANBUS документации](CANBUS.md#finding-the-canbus_uuid-for-new-micro-controllers).

## Вход в загрузчик

Когда klipper получает один из вышеперечисленных запросов загрузчика:

Если Katapult (ранее известный как CANBoot) доступен, klipper запросит, чтобы Katapult оставался активным при следующей загрузке, а затем сбросит MCU (таким образом, войдя в Katapult).

Если Katapult недоступен, klipper попытается войти в специфический для платформы загрузчик, например, в режим DFU STM32([[смотрите примечание](#stm32-dfu-warning)]).

Короче говоря, Klipper перезагрузится в Katapult, если он установлен, а затем в аппаратный загрузчик, если он доступен.

Подробную информацию о конкретных загрузчиках для различных платформ можно найти в разделе [Bootloaders](Bootloaders.md)

## Примечания

### Предупреждение STM32 DFU

Обратите внимание, что на некоторых платах, например Octopus Pro v1, вход в режим DFU может привести к нежелательным действиям (например, включению питания нагревателя в режиме DFU). Рекомендуется отключать нагреватели и иным образом предотвращать нежелательные действия при использовании режима DFU. Для получения более подробной информации обратитесь к документации на вашу плату.
