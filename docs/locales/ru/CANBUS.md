# CANBUS

В этом документе описывается поддержка шины CAN Klipper.

## Оборудование устройства

В настоящее время Klipper поддерживает CAN на микросхемах stm32, SAME5x и rp2040. Кроме того, микроконтроллерная микросхема должна быть установлена на плате, имеющей CAN-трансивер.

Чтобы скомпилировать для CAN, запустите `make menuconfig` и выберите «CAN bus» в качестве интерфейса связи. Наконец, скомпилируйте код микроконтроллера и запишите его на целевую плату.

## Оборудование хоста

Для использования шины CAN необходимо иметь хост-адаптер. Рекомендуется использовать "USB to CAN адаптер". Существует множество различных адаптеров USB to CAN от разных производителей. При выборе адаптера рекомендуется убедиться, что на нем можно обновлять прошивку. (К сожалению, мы обнаружили, что некоторые USB-адаптеры имеют дефектную прошивку и заблокированы, поэтому проверяйте их перед покупкой). Ищите адаптеры, которые могут работать с Klipper напрямую (в режиме "мост USB - CAN") или с прошивкой [candlelight прошивка](https://github.com/candle-usb/candleLight_fw).

Также необходимо настроить операционную систему хоста на использование адаптера. Обычно это делается путем создания нового файла `/etc/network/interfaces.d/can0` со следующим содержимым:

```
allow-hotplug can0
iface can0 can static
    bitrate 1000000
    up ip link set $IFACE txqueuelen 128
```

## Согласующие резисторы

Шина CAN должна иметь два резистора по 120 Ом между проводами CANH и CANL. В идеале по одному резистору, расположенному на каждом конце шины.

Обратите внимание, что некоторые устройства имеют встроенный резистор 120 Ом, который невозможно легко удалить. В некоторых устройствах резистор вообще отсутствует. Другие устройства имеют механизм для выбора резистора (обычно путем подключения "пин-перемычки"). Обязательно проверьте схемы всех устройств на шине CAN, чтобы убедиться, что на шине есть два и только два резистора 120 Ом.

Чтобы проверить правильность резисторов, можно отключить питание принтера и с помощью мультиметра проверить сопротивление между проводами CANH и CANL ‐ он должен показывать ~60 Ом на правильно подключенной шине CAN.

## Поиск canbus_uuid для новых микроконтроллеров

Каждому микроконтроллеру на шине CAN присваивается уникальный идентификатор на основе заводского идентификатора микросхемы, закодированного в каждом микроконтроллере. Чтобы найти идентификатор каждого устройства микроконтроллера, убедитесь, что оборудование подключено правильно и подключено правильно, а затем запустите:

```
~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0
```

Если обнаружены неинициализированные устройства CAN, приведенная выше команда выдаст следующие строки:

```
Найден canbus_uuid=11aa22bb33cc, Приложение: Klipper
```

Каждое устройство будет иметь уникальный идентификатор. В приведенном выше примере `11aa22bb33cc` ‐ это «canbus_uuid» микроконтроллера.

Обратите внимание, что инструмент `canbus_query.py` сообщает только о неинициализированных устройствах — если Klipper (или аналогичный инструмент) настроит устройство, оно больше не будет отображаться в списке.

## Настройка клиперов

Обновите Klipper [конфигурацию mcu](Config_Reference.md#mcu), чтобы использовать шину CAN для связи с устройством, например:

```
[mcu my_can_mcu]
canbus_uuid: 11aa22bb33cc
```

## Режим моста USB-CAN

Некоторые микроконтроллеры поддерживают выбор режима "USB на CAN шину мост" во время "make menuconfig" Klipper. Этот режим может позволить использовать микроконтроллер и как "адаптер USB к CAN-шине", и как узел Klipper.

Когда Klipper использует этот режим, микроконтроллер отображается как "USB-адаптер CAN-шины" под Linux. Сам "Klipper bridge mcu" будет отображаться так, как будто он находится на этой CAN-шине - его можно определить с помощью `canbus_query.py`, и он должен быть настроен так же, как и другие узлы CAN-шины Klipper.

Несколько важных замечаний по использованию этого режима:

* Для связи с шиной необходимо настроить интерфейс `can0` (или аналогичный) в Linux. Однако Klipper игнорирует скорость шины CAN Linux и параметры синхронизации битов CAN-шины. В настоящее время частота шины CAN указывается во время «make menuconfig», а скорость шины, указанная в Linux, игнорируется.
* При сбросе "bridge mcu" Linux отключает соответствующий интерфейс `can0`. Чтобы обеспечить правильную обработку команд FIRMWARE_RESTART и RESTART, рекомендуется использовать `allow-hotplug` в файле `/etc/network/interfaces.d/can0`. Например:

```
allow-hotplug can0
iface can0 can static
    bitrate 1000000
    up ip link set $IFACE txqueuelen 128
```

* Мостовой микроконтроллер" на самом деле не находится на шине CAN. Сообщения, поступающие в мостовой микроконтроллер, не будут видны другим адаптерам, которые могут находиться на шине CAN.
* Доступная полоса пропускания как для самого " моста mcu", так и для всех устройств на CAN-шине фактически ограничена частотой CAN-шины. Поэтому рекомендуется использовать частоту шины CAN 1000000 при использовании режима "мост USB - шина CAN".

   Даже при частоте шины CAN 1000000 может не хватить пропускной способности для выполнения теста `SHAPER_CALIBRATE`, если шаговики XY и акселерометр обмениваются данными через один интерфейс "USB - шина CAN".
* Мостовая плата USB to CAN не отображается как последовательное устройство USB, она не показывается при выполнении команды `ls /dev/serial/by-id`, и ее нельзя настроить в файле printer.cfg Klipper с параметром `serial:`. Плата моста отображается как "USB CAN адаптер" и конфигурируется в printer.cfg как [CAN узел](#configuring-klipper).

## Советы по устранению неполадок

Смотрите документ [Устранение неисправностей шины CAN](CANBUS_Troubleshooting.md).
