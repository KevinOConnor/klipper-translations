# Вклад в Klipper

Благодарим вас за внесение изменений в Klipper! Этот документ описывает процесс внесения изменений в Klipper.

Пожалуйста, обратитесь к странице [contact page](Contact.md) для получения информации о сообщении о проблеме или для получения подробной информации о том, как связаться с разработчиками.

## Обзор процесса внесения вклада

Вклад в Klipper, как правило, осуществляется в соответствии с высокоуровневым процессом:

1. Участник начинает с создания [GitHub Pull Request](https://github.com/Klipper3d/klipper/pulls), когда представленная работа готова к широкому развертыванию.
1. Когда [рецензент](#reviewers) будет доступен для [рассмотрения](#what-to-expect-in-a-review) представленного материала, он назначит себя на Pull Request на GitHub. Целью рецензирования является поиск дефектов и проверка того, что представленный материал соответствует документированным рекомендациям.
1. После успешной проверки рецензент "одобрит проверку" на GitHub, а [сопровождающий](#reviewers) зафиксирует изменение в основной ветке Klipper.

При работе над усовершенствованиями подумайте о том, чтобы начать (или внести свой вклад) тему на [Klipper Discourse](Contact.md). Постоянное обсуждение на форуме может улучшить видимость работы над улучшением и привлечь других людей, заинтересованных в тестировании новой работы.

## Что ожидать от рецензии

Вклад в Klipper проверяется перед слиянием. Основная цель процесса рецензирования - проверить наличие дефектов и убедиться, что представленные материалы соответствуют рекомендациям, указанным в документации Klipper.

Понятно, что существует множество способов выполнения задачи; целью обзора не является обсуждение "лучшей" реализации. Там, где это возможно, предпочтительны обсуждения, сосредоточенные на фактах и измерениях.

Большинство поданных работ будут сопровождаться отзывами. Будьте готовы получить отзыв, предоставить дополнительные сведения и при необходимости обновить работу.

Обычные вещи, на которые обращает внимание рецензент:

1. Нет ли в представленном материале дефектов и готов ли он к широкому внедрению?

   Ожидается, что авторы будут тестировать свои изменения перед отправкой. Рецензенты ищут ошибки, но, как правило, не тестируют представленные материалы. Принятая заявка часто распространяется на тысячи принтеров в течение нескольких недель после принятия. Поэтому качество подаваемых материалов считается приоритетным.

   Основной репозиторий [Klipper3d/klipper](https://github.com/Klipper3d/klipper) GitHub не принимает экспериментальные работы. Участники должны проводить эксперименты, отладку и тестирование в своих собственных репозиториях. Сервер [Klipper Discourse](Contact.md) - хорошее место для повышения осведомленности о новой работе и поиска пользователей, заинтересованных в предоставлении реальных отзывов.

   Представленные материалы должны пройти все [регрессионные тесты](Debugging.md).

   Исправляя дефект в коде, отправители должны иметь общее представление о первопричине этого дефекта, и исправление должно быть направлено на эту первопричину.

   Представленный код не должен содержать избыточного отладочного кода, отладочных опций или регистрации отладки во время выполнения.

   Комментарии в представленном коде должны быть направлены на улучшение сопровождения кода. Материалы не должны содержать "закомментированный код" или чрезмерные комментарии, описывающие прошлые реализации. Не должно быть чрезмерных комментариев "todo".

   Обновления документации не должны заявлять, что они являются "незавершенными".
1. Приносит ли заявка "большую пользу" реальным пользователям, выполняющим реальные задачи?

   Рецензенты должны хотя бы приблизительно определить, "кто является целевой аудиторией", приблизительную шкалу "размера этой аудитории", "пользу", которую они получат, как "польза измеряется" и "результаты этих измерений". В большинстве случаев это очевидно как для автора, так и для рецензента, и не указывается в явном виде во время рецензирования.

   Ожидается, что материалы, отправляемые в мастер-ветку Klipper, будут иметь заметную целевую аудиторию. В качестве общего "эмпирического правила", представленные материалы должны быть нацелены на базу пользователей, состоящую не менее чем из 100 реальных пользователей.

   Если рецензент просит подробно рассказать о "пользе" работы, не считайте это критикой. Возможность понять реальную пользу от изменений - естественная часть рецензирования.

   При обсуждении преимуществ предпочтительнее обсуждать "факты и измерения". В целом, рецензенты не ищут ответов типа "кто-то может найти опцию X полезной", равно как и ответов типа "эта заявка добавляет функцию, которая реализована в прошивке X". Вместо этого, как правило, предпочтительнее обсудить детали того, как измерялось улучшение качества и каковы были результаты этих измерений - например, "тесты на принтерах Acme X1000 показали улучшение углов, как видно на рисунке...", или, например, "время печати реального объекта X на принтере Foomatic X900 сократилось с 4 часов до 3,5 часов". Понятно, что тестирование такого рода может занять много времени и сил. Некоторые из наиболее заметных функций Klipper потребовались месяцы обсуждений, доработок, тестирования и документирования, прежде чем они были добавлены в основную ветку.

   Все новые модули, опции конфигурации, команды, параметры команд и документы должны иметь "высокую степень воздействия". Мы не хотим нагружать пользователей опциями, которые они не могут разумно настроить, а также не хотим нагружать их опциями, которые не дают заметных преимуществ.

   Рецензент может попросить разъяснить, как пользователь должен настраивать ту или иную опцию - идеальный ответ будет содержать подробную информацию о процессе, например, "пользователи MegaX500 должны установить опцию X на 99,3, а пользователи Elite100Y должны откалибровать опцию X с помощью процедуры ...".

   Если цель опции - сделать код более модульным, то лучше использовать константы кода, а не опции конфигурации, обращенные к пользователю.

   Новые модули, новые опции и новые параметры не должны предоставлять функциональность, аналогичную существующим модулям - если различия произвольны, предпочтительнее использовать существующую систему или рефакторить существующий код.
1. Ясно ли авторское право, не является ли оно безвозмездным и совместимым?

   Новые файлы на Си и файлы на Python должны содержать недвусмысленное заявление об авторских правах. Предпочтительный формат см. в существующих файлах. Не рекомендуется объявлять авторские права на существующий файл при внесении в него незначительных изменений.

   Код, взятый из сторонних источников, должен быть совместим с лицензией Klipper (GNU GPLv3). Крупные дополнения к стороннему коду должны быть добавлены в каталог `lib/` (и соответствовать формату, описанному в [lib/README](../lib/README)).

   Отправители должны предоставить строку [Signed-off-by](#format-of-commit-messages), используя свое полное настоящее имя. Она указывает, что отправитель согласен с [сертификатом происхождения разработчика](developer-certificate-of-origin).
1. Соответствует ли подача материала рекомендациям, указанным в документации Klipper?

   В частности, код должен следовать рекомендациям в <Code_Overview.md>, а файлы конфигурации - рекомендациям в <Example_Configs.md>.
1. Обновляется ли документация Klipper, чтобы отразить новые изменения?

   Как минимум, справочная документация должна быть обновлена с учетом соответствующих изменений в коде:

   * Все команды и параметры команд должны быть задокументированы в <G-Codes.md>.
   * Все модули, предназначенные для пользователей, и их параметры конфигурации должны быть задокументированы в <Config_Reference.md>.
   * Все экспортируемые "переменные состояния" должны быть задокументированы в <Status_Reference.md>.
   * Все новые "веб-крючки" и их параметры должны быть задокументированы в <API_Server.md>.
   * Любое изменение, которое вносит несовместимые с обратным ходом изменения в команду или настройки файла конфигурации, должно быть задокументировано в <Config_Changes.md>.

Новые документы должны быть добавлены в <Overview.md> и добавлены в индекс сайта [docs/_klipper3d/mkdocs.yml](../docs/_klipper3d/mkdocs.yml).

1. Хорошо ли сформированы коммиты, касаются ли они одной темы в каждом коммите и являются ли они независимыми?

   Сообщения коммитов должны соответствовать [предпочтительному формату](#format-of-commit-messages).

   Коммиты не должны иметь конфликтов слияния. Новые добавления в мастер-ветку Klipper всегда выполняются через "rebase" или "слияние и возврат". Как правило, сабмиттерам нет необходимости повторно сливать свои коммиты при каждом обновлении мастер-репозитория Klipper. Однако, если возникает конфликт слияния, рекомендуется использовать `git rebase` для устранения конфликта.

   Каждый коммит должен относиться к одному высокоуровневому изменению. Большие изменения должны быть разбиты на несколько независимых коммитов. Каждый коммит должен "стоять на своём", чтобы такие инструменты, как `git bisect` и `git revert`, работали надёжно.

   Изменения пробельных символов не должны смешиваться с функциональными изменениями. В целом, беспричинные изменения пробельных символов не принимаются, если только они не исходят от признанного "владельца" модифицируемого кода.

Klipper не использует строгое "руководство по стилю кодирования", но модификации существующего кода должны следовать высокоуровневому потоку кода, стилю отступов и формату существующего кода. Новые модули и системы могут быть более гибкими в отношении стиля кодирования, но предпочтительно, чтобы новый код следовал внутренне согласованному стилю и в целом соответствовал общепринятым в отрасли нормам кодирования.

Обсуждение "лучших реализаций" не является целью рецензии. Однако если рецензенту трудно понять реализацию представленного материала, он может попросить внести изменения, чтобы сделать реализацию более прозрачной. В частности, если рецензенты не могут убедить себя в том, что в представленном материале нет дефектов, то могут потребоваться изменения.

В рамках рецензирования рецензент может создать альтернативный Pull Request для темы. Это может быть сделано для того, чтобы избежать чрезмерного обсуждения мелких процедурных вопросов и тем самым упростить процесс отправки. Также это может быть сделано, потому что обсуждение вдохновляет рецензента на создание альтернативной реализации. Обе ситуации являются нормальным результатом рецензирования и не должны рассматриваться как критика исходной заявки.

### Помощь в написании обзоров

Мы благодарны за помощь с рецензиями! Не обязательно быть [перечисленным рецензентом](#reviewers), чтобы выполнять рецензирование. Авторам GitHub Pull Requests также рекомендуется рецензировать свои собственные заявки.

Чтобы помочь с рецензированием, выполните шаги, описанные в [What to expect in a review](#what-to-expect-in-a-review), чтобы проверить отправку. После завершения проверки добавьте комментарий к GitHub Pull Request с вашими выводами. Если заявка прошла проверку, укажите это в комментарии - например, что-то вроде "Я проверил это изменение в соответствии с шагами в документе CONTRIBUTING, и мне кажется, что все хорошо". Если вы не смогли выполнить некоторые этапы рецензирования, укажите, какие этапы были рассмотрены, а какие нет - например, что-то вроде "Я не проверял код на наличие дефектов, но я рассмотрел все остальное в документе CONTRIBUTING, и все выглядит хорошо".

Мы также признательны за тестирование представленных материалов. Если код был протестирован, пожалуйста, добавьте комментарий к GitHub Pull Request с результатами тестирования - успешными или неудачными. Пожалуйста, явно укажите, что код был протестирован, и результаты - например, что-то вроде "Я протестировал этот код на принтере Acme900Z с печатью вазы, и результаты были хорошими".

### Рецензенты

"Рецензентами" Клиппера являются:

| Название | GitHub Id | Сферы интересов |
| --- | --- | --- |
| Дмитрий Бутюгин | @dmbutyugin | Формирование входного сигнала, резонансное тестирование, кинематика |
| Эрик Каллахан | @Arksine | Выравнивание кровати, прошивка MCU |
| Джеймс Хартли | @JamesH1978 | Конфигурационные файлы |
| Кевин О'Коннор | @КевинОконнор | Основная система движения, код микроконтроллера |

Пожалуйста, не пингуйте рецензентов и не направляйте им заявки. Все рецензенты следят за форумами и PR, и берут на себя рецензии, когда у них есть время.

"Сопровождающими" Клиппера являются:

| Название | Название GitHub |
| --- | --- |
| Кевин О'Коннор | @КевинОконнор |

## Формат сообщений фиксации

Каждая фиксация должна содержать сообщение о фиксации в следующем формате:

```
модуль: Краткое резюме с заглавной буквы (не более 50 символов)

Более подробный пояснительный текст, если это необходимо. Сократите его примерно до 75
символов или около того. В некоторых контекстах первая строка рассматривается как тема
электронного письма, а остальная часть текста - как основной текст. Пустая строка,
отделяющая сводку от основного текста, имеет решающее значение (если только вы
не опустите тело полностью); такие инструменты, как rebase, могут запутаться, если вы
запустите их вместе.

Дальнейшие абзацы следуют за пустыми строками..

Подписано: Мое имя <myemail@example.org >
```

В приведенном выше примере `module` должно быть именем файла или каталога в репозитории (без расширения файла). Например, `clocksync: Fix typo in pause() call at connect time`. Цель указания имени модуля в сообщении о фиксации - помочь обеспечить контекст для комментариев к фиксации.

Важно иметь строку "Подписано" (Signed-off-by) при каждой фиксации - она подтверждает, что вы согласны с [developer certificate of origin](developer-certificate-of-origin). В нем должно быть указано ваше настоящее имя (извините, никаких псевдонимов или анонимных сообщений) и текущий адрес электронной почты.

## Вклад в переводы Klipper

[Klipper-translations Project](https://github.com/Klipper3d/klipper-translations) - проект, посвященный переводу Klipper на разные языки. На сайте [Weblate](https://hosted.weblate.org/projects/klipper/) размещены все строки Gettext для перевода и просмотра. Локализации могут быть отображены на [klipper3d.org](https://www.klipper3d.org), если они удовлетворяют следующим требованиям:

- [ ] 75% Общее покрытие
- [ ] Все заголовки (H1) переведены
- [ ] Обновленная навигационная иерархия PR в klipper-translations.

Чтобы уменьшить трудности перевода специфических терминов и получить информацию о текущих переводах, вы можете отправить PR, изменяющий [Klipper-translations Project](https://github.com/Klipper3d/klipper-translations) `readme.md`. Как только перевод будет готов, можно внести соответствующую модификацию в проект Klipper.

Если перевод уже существует в репозитории Klipper и больше не соответствует приведенному выше контрольному списку, он будет помечен как устаревший через месяц без обновлений.

После того как требования будут выполнены, вам необходимо:

1. обновить репозиторий klipper-tranlations [active_translations](https://github.com/Klipper3d/klipper-translations/blob/translations/active_translations)
1. Дополнительно: добавьте файл manual-index.md в папку `docs\locals\<lang>` репозитория klipper-translations, чтобы заменить специфичный для каждого языка index.md (сгенерированный index.md отображается некорректно).

Известные проблемы:

1. В настоящее время в документации нет метода правильного перевода изображений
1. Невозможно перевести заголовки в mkdocs.yml.
