# Установка

Эти инструкции предполагают, что программное обеспечение будет работать на хосте под управлением linux, на котором установлен фронт-энд, совместимый с Klipper. В качестве хост-машины рекомендуется использовать SBC (Small Board Computer), например, Raspberry Pi или Linux-устройство на базе Debian (другие варианты см. в [FAQ](FAQ.md#can-i-run-klipper-on-something-other-than-a-raspberry-pi-3)).

Для целей данной инструкции host относится к устройству Linux, а mcu - к печатной плате. SBC относится к термину Small Board Computer, например, Raspberry Pi.

## Получение файла конфигурации Klipper

Большинство настроек Klipper определяется "файлом конфигурации принтера" printer.cfg, который будет храниться на хосте. Подходящий файл конфигурации часто можно найти, заглянув в каталог Klipper [config](../config/) для поиска файла, начинающегося с префикса "printer-", который соответствует целевому принтеру. Конфигурационный файл Klipper содержит техническую информацию о принтере, которая понадобится во время установки.

Если в каталоге Klipper config нет соответствующего файла конфигурации принтера, попробуйте поискать на сайте производителя принтера, чтобы узнать, есть ли у него соответствующий файл конфигурации Klipper.

Если конфигурационный файл для принтера не найден, но известен тип платы управления принтером, то ищите соответствующий [config-файл](../config/), начинающийся с префикса "generic-". Приведенные примеры файлов платы управления принтером должны позволить успешно завершить начальную установку, но для получения полной функциональности принтера потребуется некоторая доработка.

Можно также задать новую конфигурацию принтера с нуля. Однако это требует значительных технических знаний о принтере и его электронике. Большинству пользователей рекомендуется начинать работу с соответствующего файла конфигурации. При создании нового файла конфигурации принтера следует начать с ближайшего примера [config file](../config/), а для получения дополнительной информации использовать справочник Klipper [config reference](Config_Reference.md).

## Взаимодействие с Klipper

Klipper - это прошивка для 3d-принтера, поэтому пользователю нужно как-то взаимодействовать с ней.

В настоящее время лучшим выбором являются фронт-энды, получающие информацию через [Moonraker web API](https://moonraker.readthedocs.io/), также есть возможность использовать [Octoprint](https://octoprint.org/) для управления Klipper.

Выбор остается за пользователем, но основа Klipper во всех случаях одинакова. Мы рекомендуем пользователям изучить доступные варианты и принять взвешенное решение.

## Получение образа ОС для SBC

Существует множество способов получить образ ОС для Klipper для использования на SBC, большинство из них зависит от того, какой фронт-энд вы хотите использовать. Некоторые производители этих плат SBC также предоставляют свои собственные образы, ориентированные на Klipper.

Два основных фронт-энда на базе Moonraker - это [Fluidd](https://docs.fluidd.xyz/) и [Mainsail](https://docs.mainsail.xyz/), последний из которых имеет готовый установочный образ ["MainsailOS"](http://docs.mainsailOS.xyz), в котором есть возможность установки на Raspberry Pi и некоторые варианты OrangePi.

Fluidd можно установить с помощью KIAUH (Klipper Install And Update Helper), о котором рассказывается ниже, и который является сторонним инсталлятором для всех вещей Klipper.

OctoPrint может быть установлен через популярный образ OctoPi или через KIAUH, этот процесс описан в <OctoPrint.md>

## Установка через KIAUH

Обычно вы начинаете с базового образа для вашего SBC, например, RPiOS Lite или, в случае устройства с x86 Linux, Ubuntu Server. Обратите внимание, что Desktop-варианты не рекомендуются из-за некоторых вспомогательных программ, которые могут помешать работе некоторых функций Klipper и даже заблокировать доступ к некоторым печатающим платам.

KIAUH можно использовать для установки Klipper и связанных с ним программ на различные системы на базе Linux, работающие под управлением Debian. Более подробную информацию можно найти на сайте https://github.com/dw-0/kiauh

## Компиляция и прошивка микроконтроллера

Чтобы скомпилировать код микроконтроллера, начните с выполнения этих команд на хост-устройстве:

```
cd ~/klipper/
make menuconfig
```

Комментарии в верхней части файла [printer configuration file](#obtain-a-klipper-configuration-file) должны описывать настройки, которые необходимо задать при выполнении команды "make menuconfig". Откройте файл в браузере или текстовом редакторе и найдите эти инструкции в верхней части файла. После того как соответствующие настройки "menuconfig" будут заданы, нажмите "Q" для выхода, а затем "Y" для сохранения. Затем запустите программу:

```
make
```

Если в комментариях в верхней части файла [printer configuration file](#obtain-a-klipper-configuration-file) описаны пользовательские шаги по "прошивке" конечного изображения на плату управления принтером, то выполните эти шаги, а затем перейдите к [configuring OctoPrint](#configuring-octoprint-to-use-klipper).

В противном случае для "прошивки" платы управления принтером часто используются следующие действия. Во-первых, необходимо определить последовательный порт, подключенный к микроконтроллеру. Для этого выполните следующее:

```
ls /dev/serial/by-id/*
```

Должно отобразиться что-то вроде:

```
/dev/serial/by-id/usb-1a86_USB2.0-Serial-if00-port0
```

Обычно каждый принтер имеет свое уникальное имя последовательного порта. Это уникальное имя будет использоваться при прошивке микроконтроллера. Возможно, в приведенном выше выводе будет несколько строк - если это так, выберите строку, соответствующую микроконтроллеру. Если в списке много элементов и выбор неоднозначен, отключите плату и запустите команду снова, недостающим элементом будет ваша печатная плата (см. дополнительную информацию в [FAQ](FAQ.md#wheres-my-serial-port)).

Для распространенных микроконтроллеров с микросхемами STM32 или клонами, микросхемами LPC и другими обычно требуется начальная прошивка Klipper через SD-карту.

При прошивке этим методом важно убедиться, что печатная плата не подключена к хосту через USB, так как некоторые платы могут подавать питание обратно на плату и препятствовать возникновению вспышки.

Для распространенных микроконтроллеров, использующих микросхемы Atmega, например 2560, код можно прошить примерно так:

```
sudo service klipper stop

make flash FLASH_DEVICE=/dev/serial/by-id/usb-1a86_USB2.0-Serial-if00-port0

sudo service klipper start
```

Не забудьте заменить значение FLASH_DEVICE на имя порта вашего принтера.

Для распространенных микроконтроллеров, использующих микросхемы RP2040, код можно прошить примерно так:

```
sudo service klipper stop
make flash FLASH_DEVICE=first
sudo service klipper start
```

Важно отметить, что перед этой операцией микросхемы RP2040 могут быть переведены в режим загрузки.

## Настройка клиперов

Следующим шагом будет копирование [файла конфигурации принтера](#obtain-a-klipper-configuration-file) на хост.

Пожалуй, самый простой способ настроить конфигурационный файл Klipper - это использовать встроенные редакторы в Mainsail или Fluidd. Они позволят пользователю открыть примеры конфигурации и сохранить их в файле printer.cfg.

Другой вариант - использовать настольный редактор, поддерживающий редактирование файлов по протоколам "scp" и/или "sftp". Существуют свободно распространяемые инструменты, поддерживающие эту функцию (например, Notepad++, WinSCP и Cyberduck). Загрузите файл конфигурации принтера в редактор, а затем сохраните его в виде файла с именем "printer.cfg" в домашнем каталоге пользователя pi (например, /home/pi/printer.cfg).

В качестве альтернативы можно скопировать и отредактировать файл непосредственно на хосте через ssh. Это может выглядеть примерно так (не забудьте обновить команду, чтобы использовать соответствующее имя файла конфигурации принтера):

```
cp ~/klipper/config/example-cartesian.cfg ~/printer.cfg
nano ~/printer.cfg
```

Обычно каждый принтер имеет свое собственное уникальное имя для микроконтроллера. После прошивки Klipper это имя может измениться, поэтому повторите эти шаги еще раз, даже если они уже были выполнены при прошивке. Выполнить:

```
ls /dev/serial/by-id/*
```

Должно отобразиться что-то вроде:

```
/dev/serial/by-id/usb-1a86_USB2.0-Serial-if00-port0
```

Затем обновите конфигурационный файл с уникальным именем. Например, обновите секцию `[mcu]`, чтобы она выглядела примерно так:

```
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB2.0-Serial-if00-port0
```

После создания и редактирования файла необходимо будет выполнить команду "restart" в командной консоли для загрузки конфигурации. Команда "status" сообщит о готовности принтера, если файл конфигурации Klipper успешно прочитан, а микроконтроллер успешно найден и настроен.

При настройке файла конфигурации принтера нередко Klipper сообщает об ошибке конфигурации. При возникновении ошибки внесите необходимые исправления в файл конфигурации принтера и выполняйте команду "restart" до тех пор, пока "status" не сообщит о готовности принтера.

Klipper сообщает об ошибках через командную консоль и всплывающие окна во Fluidd и Mainsail. Команда "статус" может быть использована для повторного отображения сообщений об ошибках. Имеется журнал, который обычно располагается в ~/printer_data/logs и имеет имя klippy.log

После того как Klipper сообщит, что принтер готов, перейдите к документу [Проверка конфигурации](Config_checks.md) для выполнения некоторых базовых проверок определений в файле конфигурации. Другую информацию см. в основной части [справочной документации](Overview.md).
