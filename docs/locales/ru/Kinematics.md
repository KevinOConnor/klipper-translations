# Кинематика

В этом документе представлен обзор того, как Klipper реализует движение робота (его [кинематика] (https://en.wikipedia.org/wiki/Kinematics )). Содержание может представлять интерес как для разработчиков, заинтересованных в работе над программным обеспечением Klipper, так и для пользователей, заинтересованных в лучшем понимании механики своих машин.

## Ускорение

Klipper реализует схему постоянного ускорения всякий раз, когда печатающая головка меняет скорость - скорость постепенно изменяется на новую скорость, а не внезапно переключается на нее. Клиппер всегда обеспечивает ускорение между инструментальной головкой и отпечатком. Нить, выходящая из экструдера, может быть довольно хрупкой - быстрые рывки и / или изменение потока экструдера приводят к низкому качеству и плохой адгезии к слою. Даже при отсутствии выдавливания, если печатающая головка находится на том же уровне, что и печать, быстрое подергивание головки может привести к разрыву недавно нанесенной нити накала. Ограничение изменения скорости печатающей головки (относительно печати) снижает риск прерывания печати.

Также важно ограничить ускорение, чтобы шаговые двигатели не пропускали и не создавали чрезмерной нагрузки на машину. Klipper ограничивает крутящий момент на каждом шаговом механизме за счет ограничения ускорения печатающей головки. Принудительное ускорение печатающей головки, естественно, также ограничивает крутящий момент шаговых двигателей, которые перемещают печатающую головку (обратное не всегда верно).

Klipper реализует постоянное ускорение. Ключевой формулой для постоянного ускорения является:

```
скорость(время) = start_velocity + accel*time
```

## Генератор трапеций

В Klipper используется традиционный "генератор трапеций" для моделирования движения каждого хода - каждый ход имеет начальную скорость, разгоняется до крейсерской скорости с постоянным ускорением, движется с постоянной скоростью, а затем замедляется до конечной скорости с постоянным ускорением.

![trapezoid](img/trapezoid.svg.png)

Его называют "генератором трапеций", потому что диаграмма скорости движения похожа на трапецию.

Крейсерская скорость всегда больше или равна как начальной, так и конечной скорости. Фаза разгона может быть нулевой (если начальная скорость равна крейсерской), фаза крейсерской может быть нулевой (если после разгона движение сразу начинает замедляться), и/или фаза замедления может быть нулевой (если конечная скорость равна крейсерской).

![trapezoids](img/trapezoids.svg.png)

## Look-ahead

Система "look-ahead" используется для определения скорости прохождения поворотов между ходами.

Рассмотрим следующие два движения, расположенные на плоскости XY:

![corner](img/corner.svg.png)

В описанной выше ситуации можно полностью замедлиться после первого движения и затем полностью ускориться в начале следующего движения, но это не идеальный вариант, поскольку все эти ускорения и замедления значительно увеличат время печати, а частые изменения потока в экструдере приведут к ухудшению качества печати.

Чтобы решить эту проблему, механизм "look-ahead" ставит в очередь несколько входящих ходов и анализирует углы между ними, чтобы определить разумную скорость, которую можно получить на "стыке" между двумя ходами. Если следующий ход почти в том же направлении, то голове нужно лишь немного замедлиться (если это вообще возможно).

![lookahead](img/lookahead.svg.png)

Однако если следующий ход образует острый угол (голова будет двигаться почти в обратном направлении на следующем ходу), то допускается лишь небольшая скорость перехода.

![lookahead](img/lookahead-slow.svg.png)

Скорости на перекрестках определяются с помощью "приближенного центростремительного ускорения". Лучшее [описано автором](https://onehossshay.wordpress.com/2011/09/24/improving_grbl_cornering_algorithm/). Однако в Klipper скорости переходов настраиваются путем указания желаемой скорости, которую должен иметь угол 90° ("квадратная угловая скорость"), а скорости переходов для других углов определяются исходя из этого.

Ключевая формула для прогнозирования:

```
end_velocity^2 = start_velocity^2 + 2*accel*move_distance
```

### Минимальный коэффициент крейсерского хода

В Klipper также реализован механизм сглаживания движений при коротких "зигзагообразных" перемещениях. Рассмотрим следующие ходы:

![zigzag](img/zigzag.svg.png)

Частые переходы от ускорения к замедлению могут вызвать вибрацию машины, что приводит к нагрузке на машину и повышению уровня шума. В Klipper реализован механизм, обеспечивающий движение на крейсерской скорости между ускорением и замедлением. Это достигается за счет снижения максимальной скорости некоторых движений (или последовательности движений), чтобы обеспечить минимальное расстояние, пройденное на крейсерской скорости, по сравнению с расстоянием, пройденным во время ускорения и замедления.

Klipper реализует эту функцию, отслеживая как обычное ускорение движения, так и виртуальную скорость "ускорения - замедления":

![smoothed](img/smoothed.svg.png)

В частности, код вычисляет, какой была бы скорость каждого движения, если бы оно было ограничено этим виртуальным значением "ускорения - замедления". На рисунке выше пунктирные серые линии представляют собой виртуальное ускорение для первого хода. Если ход не может достичь своей полной крейсерской скорости, используя эту виртуальную скорость ускорения, то его максимальная скорость снижается до максимальной скорости, которую он мог бы получить при этой виртуальной скорости ускорения.

Для большинства ходов предел будет находиться на уровне или выше существующих пределов хода, и никаких изменений в поведении не произойдет. Однако для коротких зигзагообразных ходов этот предел снижает максимальную скорость. Обратите внимание, что это не изменяет фактического ускорения в пределах хода - ход продолжает использовать обычную схему ускорения до своей скорректированной максимальной скорости.

## Генерация шагов

После завершения процесса просмотра вперед движение печатающей головки для данного перемещения полностью известно (время, начальная позиция, конечная позиция, скорость в каждой точке), и можно генерировать время шага для этого перемещения. Этот процесс выполняется в рамках "кинематических классов" в коде Klipper. За пределами этих кинематических классов все отслеживается в миллиметрах, секундах и в декартовом координатном пространстве. Задача кинематических классов - преобразовать эту общую систему координат в аппаратную специфику конкретного принтера.

Klipper использует [итерационный решатель](https://en.wikipedia.org/wiki/Root-finding_algorithm) для генерации времени шага для каждого шага. Код содержит формулы для вычисления идеальных декартовых координат головы в каждый момент времени, а также кинематические формулы для вычисления идеальных положений шага на основе этих декартовых координат. С помощью этих формул Klipper может определить идеальное время, в течение которого шаговый механизм должен находиться в каждом положении шага. Затем заданные шаги планируются на это рассчитанное время.

Ключевая формула для определения расстояния, которое должно пройти движение при постоянном ускорении, такова:

```
move_distance = (start_velocity + .5 * accel * move_time) * move_time
```

а ключевая формула для движения с постоянной скоростью такова:

```
move_distance = cruise_velocity * move_time
```

Ключевыми формулами для определения картезианской координаты перемещения при заданном расстоянии перемещения являются:

```
cartesian_x_position = start_x + move_distance * total_x_movement / total_movement
cartesian_y_position = start_y + move_distance * total_y_movement / total_movement
cartesian_z_position = start_z + move_distance * total_z_movement / total_movement
```

### Декартовы роботы

Генерация шагов для картезианских принтеров - самый простой случай. Перемещение по каждой оси напрямую связано с перемещением в картезианском пространстве.

Ключевые формулы:

```
stepper_x_position = cartesian_x_position
stepper_y_position = cartesian_y_position
stepper_z_position = cartesian_z_position
```

### Роботы CoreXY

Генерация шагов на машине CoreXY лишь немного сложнее, чем у базовых картезианских роботов. Ключевыми формулами являются:

```
stepper_a_position = cartesian_x_position + cartesian_y_position
stepper_b_position = cartesian_x_position - cartesian_y_position
stepper_z_position = cartesian_z_position
```

### Роботы Дельта

Генерация шагов на дельта-роботе основана на теореме Пифагора:

```
stepper_position = (sqrt(arm_length^2
                         - (cartesian_x_position - tower_x_position)^2
                         - (cartesian_y_position - tower_y_position)^2)
                    + cartesian_z_position)
```

### Пределы ускорения шагового двигателя

При использовании дельта-кинематики возможно, что для движения, которое ускоряется в декартовом пространстве, потребуется ускорение на определенном шаговом двигателе, превышающее ускорение движения. Это может произойти, когда шаговый рычаг расположен более горизонтально, чем вертикально, и линия движения проходит рядом с башней этого шагового двигателя. Хотя для таких перемещений может потребоваться ускорение шагового двигателя, превышающее максимальное сконфигурированное ускорение перемещения принтера, эффективная масса, перемещаемая этим шаговым двигателем, будет меньше. Таким образом, более высокое ускорение шагового двигателя не приводит к значительному увеличению крутящего момента шагового двигателя и поэтому считается безвредным.

Однако, чтобы избежать экстремальных ситуаций, Klipper устанавливает максимальный предел ускорения шагового механизма, в три раза превышающий настроенное максимальное ускорение перемещения принтера. (Аналогично, максимальная скорость шагового механизма ограничена трехкратным значением максимальной скорости перемещения). Чтобы обеспечить соблюдение этого ограничения, перемещения у крайних границ области сборки (где шаговый манипулятор может быть почти горизонтальным) будут иметь меньшее максимальное ускорение и скорость.

### Кинематика экструдера

Klipper реализует движение экструдера в собственном кинематическом классе. Поскольку время и скорость перемещения каждой печатающей головки полностью известны для каждого движения, можно рассчитывать время шага для экструдера независимо от расчета времени шага перемещения печатающей головки.

Базовое движение экструдера легко рассчитать. Для генерации шагового времени используются те же формулы, что и для картезианских роботов:

```
stepper_position = requested_e_position
```

### Повышение давления

Эксперименты показали, что можно улучшить моделирование экструдера, выйдя за рамки базовой формулы экструдера. В идеальном случае по мере продвижения экструзии в каждой точке на пути движения должен осаждаться одинаковый объем филамента, а после движения не должно быть никакого объема, выдавливаемого из экструдера. К сожалению, часто случается, что базовые формулы экструзии приводят к тому, что в начале движения экструзии из экструдера выходит слишком мало филамента, а после окончания экструзии выдавливается избыток филамента. Это часто называют "сочиться".

![ooze](img/ooze.svg.png)

Система " давление вперед" пытается учесть это, используя другую модель для экструдера. Вместо того чтобы наивно полагать, что каждый мм^3 нити, поданной в экструдер, приведет к тому, что это количество мм^3 немедленно выйдет из экструдера, она использует модель, основанную на давлении. Давление увеличивается, когда нить проталкивается в экструдер (как в [законе Гука](https://en.wikipedia.org/wiki/Hooke%27s_law)), а давление, необходимое для экструзии, зависит от скорости потока через отверстие сопла (как в [законе Пуазейля](https://en.wikipedia.org/wiki/Poiseuille_law)). Основная идея заключается в том, что связь между нитью, давлением и скоростью потока может быть смоделирована с помощью линейного коэффициента:

```
pa_position = nominal_position + pressure_advance_coefficient * nominal_velocity
```

Информацию о том, как найти этот коэффициент опережения давления, смотрите в документе [pressure advance](Pressure_Advance.md).

Базовая формула опережения давления может привести к резкому изменению скорости двигателя экструдера. Чтобы избежать этого, в Klipper реализовано "сглаживание" движения экструдера.

![pressure-advance](img/pressure-velocity.png)

На приведенном выше графике показан пример двух движений экструдера с ненулевой угловой скоростью между ними. Обратите внимание на то, что система опережения давления приводит к тому, что во время ускорения в экструдер проталкивается дополнительное количество нити. Чем выше желаемая скорость потока нити, тем больше нити должно подаваться во время ускорения, чтобы учесть давление. Во время замедления головки дополнительная нить втягивается (экструдер будет иметь отрицательную скорость).

Сглаживание осуществляется с помощью средневзвешенного значения положения экструдера за небольшой промежуток времени (как указано в параметре конфигурации `pressure_advance_smooth_time`). Это усреднение может охватывать несколько движений g-кода. Обратите внимание, что двигатель экструдера начинает двигаться до номинального начала первого хода экструзии и продолжает двигаться после номинального окончания последнего хода экструзии.

Ключевая формула для "сглаженного опережения давления":

```
smooth_pa_position(t) =
    ( definitive_integral(pa_position(x) * (smooth_time/2 - abs(t - x)) * dx,
                          from=t-smooth_time/2, to=t+smooth_time/2)
     / (smooth_time/2)^2 )
```
