# Компенсация Резонанса

Klipper поддерживает формирование входных данных - метод, который можно использовать для уменьшения звона (также известного как эхо, ореолы или рябь) в отпечатках. Звон - это дефект поверхностной печати, когда, как правило, такие элементы, как края, повторяются на печатной поверхности в виде едва уловимого "эха":

|![Ringing test](img/ringing-test.jpg)|![3D Benchy](img/ringing-3dbenchy.jpg)|

Звон вызывается механическими вибрациями в принтере из-за быстрой смены направления печати. Обратите внимание, что звон обычно имеет механическое происхождение: недостаточно жесткая рама принтера, негерметичные или слишком пружинистые ремни, проблемы с выравниванием механических деталей, тяжелая движущаяся масса и т.д. Они должны быть проверены и исправлены в первую очередь, если это возможно.

[Input shaping](https://en.wikipedia.org/wiki/Input_shaping ) - это метод управления с разомкнутым контуром, который создает командный сигнал, гасящий его собственные вибрации. Формирование входных данных требует некоторой настройки и измерений, прежде чем его можно будет включить. Помимо звона, формирование входных сигналов обычно уменьшает вибрации и тряску принтера в целом, а также может повысить надежность режима stealthChop в Trinamic stepper drivers.

## Тюнинг

Базовая настройка требует измерения частоты звона принтера путем печати тестовой модели.

Разрезать тестовую модель кольца, которая находится в [docs/prints/ringing_tower.stl](prints/ringing_tower.stl), в слайсере:

* Рекомендуемая высота слоя 0.2 или 0.25 мм
* Наполняющий и верхний слои можно установить на 0.
* Используйте 1-2 периметра, а еще лучше режим гладкой вазы с основанием 1-2 мм.
* Используйте достаточно высокую скорость, около 80-100 мм/с, для **внешнего** периметра.
* Убедитесь, что минимальное время слоя составляет **не более** 3 секунд.
* Убедитесь, что в слайсере отключен любой "контроль динамического ускорения".
* Не поворачивайте модель. На модели есть метки X и Y на задней части модели. Обратите внимание на необычное расположение меток относительно осей принтера - это не ошибка. Эти метки можно использовать позже в процессе настройки в качестве справочника, поскольку они показывают, какой оси соответствуют измерения.

### Частота звонков

Сначала измерьте **частоту звонка**.

1. Если параметр `square_corner_velocity` был изменен, верните его к значению 5.0. Не рекомендуется увеличивать этот параметр при использовании входного формирователя, поскольку это может привести к сглаживанию деталей - вместо этого лучше использовать более высокое значение ускорения.
1. Отключите функцию `minimum_cruise_ratio`, выполнив следующую команду: `SET_VELOCITY_LIMIT MINIMUM_CRUISE_RATIO=0`
1. Отключить опережение давления: `SET_PRESSURE_ADVANCE ADVANCE=0`
1. Если вы уже добавили секцию `[input_shaper]` в printer.cfg, выполните команду `SET_INPUT_SHAPER SHAPER_FREQ_X=0 SHAPER_FREQ_Y=0`. Если вы получите ошибку " Неизвестная команда", можете смело игнорировать ее и продолжить измерения.
1. Выполните команду: `TUNING_TOWER COMMAND=SET_VELOCITY_LIMIT PARAMETER=ACCEL START=1500 STEP_DELTA=500 STEP_HEIGHT=5` По сути, мы пытаемся сделать звон более выраженным, задавая различные большие значения ускорения. Эта команда будет увеличивать ускорение каждые 5 мм, начиная с 1500 мм/сек^2: 1500 мм/сек^2, 2000 мм/сек^2, 2500 мм/сек^2 и так далее до 7000 мм/сек^2 на последнем диапазоне.
1. Распечатайте тестовую модель, нарезанную с предложенными параметрами.
1. Вы можете остановить печать раньше, если звон хорошо заметен и вы видите, что ускорение становится слишком высоким для вашего принтера (например, принтер слишком сильно трясется или начинает пропускать шаги).
1. Используйте метки X и Y на задней стороне модели для справки. Измерения со стороны с меткой X должны использоваться для настройки оси X, а метка Y - для настройки оси Y. Измерьте расстояние *D* (в мм) между несколькими колебаниями на детали с меткой X, рядом с выемками, желательно пропуская первое колебание или два. Чтобы легче измерить расстояние между колебаниями, сначала отметьте колебания, а затем измерьте расстояние между метками с помощью линейки или штангенциркуля:

   |![Mark ringing](img/ringing-mark.jpg)|![Measure ringing](img/ringing-measure.jpg)|
1. Подсчитайте, скольким колебаниям *N* соответствует измеренное расстояние *D*. Если вы не знаете, как считать колебания, обратитесь к рисунку выше, на котором показано *N* = 6 колебаний.
1. Вычислите частоту звона по оси X как *V* &middot; *N* / *D* (Гц), где *V* - скорость движения по внешнему периметру (мм/с). Для примера выше мы отметили 6 колебаний, а тест был напечатан со скоростью 100 мм/с, поэтому частота составляет 100 * 6 / 12,14 ≈ 49,4 Гц.
1. Выполните пункты (8) - (10) для метки Y.

Обратите внимание, что звон на тестовом отпечатке должен повторять форму изогнутых надрезов, как на рисунке выше. Если этого не происходит, значит, данный дефект не является звоном и имеет другое происхождение - либо механическое, либо связанное с экструдером. Ее следует устранить в первую очередь, прежде чем включать и настраивать входные формирователи.

Если измерения ненадежны, например, потому, что расстояние между колебаниями не стабильно, это может означать, что принтер имеет несколько резонансных частот на одной оси. Вместо этого можно попробовать выполнить процесс настройки, описанный в разделе [Ненадежные измерения частот звона](#unreliable-measurements-of-ringing-frequencies), и все равно получить что-то от техники формирования входного сигнала.

Частота звона может зависеть от положения модели в билдплейте и высоты по оси Z, *особенно на дельта-принтерах*; вы можете проверить, видна ли разница в частоте звона в разных положениях вдоль сторон тестовой модели и на разных высотах. В этом случае можно рассчитать средние частоты звона по осям X и Y.

Если измеренная частота звона очень низкая (ниже примерно 20-25 Гц), возможно, стоит вложить средства в усиление жесткости принтера или уменьшение подвижной массы - в зависимости от того, что применимо в вашем случае, - прежде чем приступать к дальнейшей настройке входного сигнала и повторному измерению частоты после этого. Для многих популярных моделей принтеров часто уже есть готовые решения.

Обратите внимание, что частота звонка может измениться, если в принтер будут внесены изменения, которые повлияют на подвижную массу или, например, изменят жесткость системы:

* Некоторые инструменты устанавливаются, удаляются или заменяются на инструментальной головке, что изменяет ее массу, например, устанавливается новый (более тяжелый или более легкий) шаговый двигатель для прямого экструдера или новый хотэнд, добавляется тяжелый вентилятор с воздуховодом и т.д.
* Ремни затянуты.
* Установлены некоторые аддоны для увеличения жесткости рамы.
* Различные кровати устанавливаются на принтер-раскладушку, или добавляется стекло и т.д.

При внесении таких изменений стоит хотя бы измерить частоту звонков, чтобы убедиться, что она изменилась.

### Конфигурация входного формирователя

После измерения частот звона по осям X и Y можно добавить следующий раздел в файл `printer.cfg`:

```
[input_shaper]
shaper_freq_x: ...  # частота для метки X тестовой модели
shaper_freq_y: ...  # частота для метки Y тестовой модели
```

Для приведенного выше примера мы получим shaper_freq_x/y = 49,4.

### Выбор входного формирователя

Klipper поддерживает несколько входных формирователей. Они различаются чувствительностью к ошибкам при определении резонансной частоты и степенью сглаживания напечатанных деталей. Кроме того, некоторые шейперы, например 2HUMP_EI и 3HUMP_EI, обычно не следует использовать с shaper_freq = резонансная частота - они настроены из разных соображений, чтобы уменьшить несколько резонансов одновременно.

Для большинства принтеров можно рекомендовать шейперы MZV или EI. В этом разделе описывается процесс тестирования для выбора между ними и определения некоторых других сопутствующих параметров.

Распечатайте тестовую модель звонка следующим образом:

1. Перезапустите прошивку: `ПЕРЕЗАПУСК`
1. Подготовьтесь к тесту: `SET_VELOCITY_LIMIT MINIMUM_CRUISE_RATIO=0`
1. Отключить опережение давления: `SET_PRESSURE_ADVANCE ADVANCE=0`
1. Выполнить: `SET_INPUT_SHAPER SHAPER_TYPE=MZV`
1. Выполните команду: `TUNING_TOWER COMMAND=SET_VELOCITY_LIMIT PARAMETER=ACCEL START=1500 STEP_DELTA=500 STEP_HEIGHT=5`
1. Распечатайте тестовую модель, нарезанную с предложенными параметрами.

Если на этом этапе звон отсутствует, то можно рекомендовать использовать формирователь MZV.

Если вы все же заметили звон, повторно измерьте частоты, используя шаги (8)-(10), описанные в разделе [Частота звона](#ринг-частота). Если частоты значительно отличаются от полученных ранее значений, необходима более сложная конфигурация входного формирователя. Вы можете обратиться к техническим деталям раздела [Входные формирователи](#input-shapers). В противном случае перейдите к следующему шагу.

Теперь попробуйте использовать входной формирователь EI. Для этого повторите шаги (1)-(6), описанные выше, но на шаге 4 выполните следующую команду: `SET_INPUT_SHAPER SHAPER_TYPE=EI`.

Сравните два отпечатка с входным формирователем MZV и EI. Если EI показывает заметно лучшие результаты, чем MZV, используйте формирователь EI, в противном случае предпочтите MZV. Обратите внимание, что формирователь EI приведет к большему сглаживанию напечатанных деталей (подробности см. в следующем разделе). Добавьте параметр `shaper_type: mzv` (или ei) в секцию [input_shaper], например:

```
[input_shaper]
shaper_freq_x: ...
shaper_freq_y: ...
shaper_type: mzv
```

Несколько замечаний по выбору шейпера:

* Формирователь EI может больше подходить для принтеров со станиной (если позволяет резонансная частота и получаемое сглаживание): поскольку на движущуюся станину укладывается больше филамента, масса станины увеличивается, и резонансная частота уменьшается. Поскольку формирователь EI более устойчив к изменениям резонансной частоты, он может лучше работать при печати крупных деталей.
* Из-за особенностей дельта-кинематики резонансные частоты могут сильно отличаться в разных частях объема сборки. Поэтому EI-шейпер может лучше подходить для дельта-принтеров, чем MZV или ZV, и должен быть рассмотрен для использования. Если резонансная частота достаточно велика (более 50-60 Гц), то можно даже попытаться протестировать шейпер 2HUMP_EI (выполнив предложенный выше тест с `SET_INPUT_SHAPER SHAPER_TYPE=2HUMP_EI`), но перед включением проверьте соображения в [разделе ниже](#selecting-max_accel).

### Выбор max_accel

У вас должен быть распечатан тест для шейпера, который вы выбрали на предыдущем шаге (если его нет, распечатайте тестовую модель, нарезанную с [предложенными параметрами](#tuning) с отключенным опережением давления `SET_PRESSURE_ADVANCE ADVANCE=0` и с включенной настроечной башней `TUNING_TOWER COMMAND=SET_VELOCITY_LIMIT PARAMETER=ACCEL START=1500 STEP_DELTA=500 STEP_HEIGHT=5`). Обратите внимание, что при очень высоких ускорениях, в зависимости от резонансной частоты и выбранного входного формирователя (например, формирователь EI создает больше сглаживания, чем MZV), входной формирователь может вызвать слишком сильное сглаживание и округление деталей. Поэтому max_accel следует выбирать так, чтобы этого не произошло. Еще один параметр, который может повлиять на сглаживание, - `square_corner_velocity, поэтому не рекомендуется увеличивать его выше установленного по умолчанию значения 5 мм/с, чтобы предотвратить усиление сглаживания.

Чтобы выбрать подходящее значение max_accel, проверьте модель для выбранного входного формирователя. Сначала обратите внимание на то, при каком ускорении звон все еще мал - чтобы вам было комфортно с ним работать.

Затем проверьте сглаживание. Чтобы помочь в этом, в тестовой модели есть небольшой зазор в стене (0,15 мм):

![Test gap](img/smoothing-test.png)

С увеличением ускорения увеличивается и сглаживание, а фактический разрыв в отпечатке увеличивается:

![Shaper smoothing](img/shaper-smoothing.jpg)

На этом рисунке ускорение увеличивается слева направо, а разрыв начинает расти, начиная с 3500 мм/сек^2 (5-я полоса слева). Поэтому в данном случае хорошим значением для max_accel = 3000 (мм/сек^2), чтобы избежать чрезмерного сглаживания.

Обратите внимание на ускорение, когда зазор в тестовом отпечатке еще очень мал. Если вы видите выпуклости, но зазора в стенке нет даже при высоких ускорениях, это может быть связано с отключенным Pressure Advance, особенно на экструдерах Bowden. В этом случае вам может потребоваться повторить печать с включенным PA. Это также может быть результатом неправильной калибровки (слишком высокого) потока филамента, поэтому стоит проверить и это.

Выберите минимальное из двух значений ускорения (от звонка и сглаживания) и поместите его как `max_accel` в printer.cfg.

Следует отметить, что может случиться, особенно при низких частотах звона, что формирователь EI будет вызывать слишком сильное сглаживание даже при низких ускорениях. В этом случае MZV может оказаться лучшим выбором, поскольку он допускает более высокие значения ускорения.

На очень низких частотах звона (~25 Гц и ниже) даже MZV-шейпер может создавать слишком сильное сглаживание. Если это так, вы также можете попробовать повторить шаги из раздела [Выбор входного формирователя](#choosing-input-shaper) с формирователем ZV, используя вместо него команду `SET_INPUT_SHAPER SHAPER_TYPE=ZV`. Формирователь ZV должен показать еще меньшее сглаживание, чем MZV, но он более чувствителен к ошибкам при измерении частот звона.

Еще одно соображение: если резонансная частота слишком низкая (ниже 20-25 Гц), возможно, стоит увеличить жесткость принтера или уменьшить подвижную массу. В противном случае ускорение и скорость печати могут быть ограничены из-за слишком сильного сглаживания вместо звона.

### Тонкая настройка резонансных частот

Обратите внимание, что точность измерения резонансных частот с помощью тестовой модели звона достаточна для большинства целей, поэтому дальнейшая настройка не рекомендуется. Если вы все же хотите перепроверить результаты (например, если после печати тестовой модели с выбранным вами входным формирователем с теми же частотами, которые вы измеряли ранее, вы все еще видите звон), вы можете выполнить действия, описанные в этом разделе. Обратите внимание, что если после включения [input_shaper] вы видите звон на разных частотах, этот раздел не поможет.

Предполагая, что вы нарезали модель звона с предложенными параметрами, выполните следующие шаги для каждой из осей X и Y:

1. Подготовьтесь к тесту: `SET_VELOCITY_LIMIT MINIMUM_CRUISE_RATIO=0`
1. Убедитесь, что опережение давления отключено: `SET_PRESSURE_ADVANCE ADVANCE=0`
1. Выполнить: `SET_INPUT_SHAPER SHAPER_TYPE=ZV`
1. Из существующей тестовой модели звона с выбранным вами входным формирователем выберите ускорение, которое достаточно хорошо показывает звон, и установите его с помощью: `SET_VELOCITY_LIMIT ACCEL=...`
1. Рассчитайте необходимые параметры для команды `TUNING_TOWER` для настройки параметра `shaper_freq_x` следующим образом: start = shaper_freq_x * 83 / 132 и factor = shaper_freq_x / 66, где `shaper_freq_x` здесь - текущее значение в файле `printer.cfg`.
1. Выполните команду: `TUNING_TOWER COMMAND=SET_INPUT_SHAPER PARAMETER=SHAPER_FREQ_X START=start FACTOR=factor BAND=5`, используя значения `start` и `factor`, рассчитанные на шаге (5).
1. Распечатайте тестовую модель.
1. Сбросьте исходное значение частоты: `SET_INPUT_SHAPER SHAPER_FREQ_X=...`.
1. Найдите группу, которая звонит меньше всего, и отсчитайте ее номер снизу, начиная с 1.
1. Рассчитайте новое значение shaper_freq_x через старое shaper_freq_x * (39 + 5 * #band-number) / 66.

Повторите эти действия для оси Y таким же образом, заменив ссылки на ось X на ось Y (например, замените `shaper_freq_x` на `shaper_freq_y` в формулах и в команде `TUNING_TOWER`).

В качестве примера предположим, что вы измерили частоту звонка для одной из осей, равную 45 Гц. Это дает значения start = 45 * 83 / 132 = 28,30 и factor = 45 / 66 = 0,6818 для команды `TUNING_TOWER`. Теперь предположим, что после печати тестовой модели четвертая полоса снизу дает наименьший звон. Это дает обновленное значение shaper_freq_? равное 45 * (39 + 5 * 4) / 66 ≈ 40,23.

После того как оба новых параметра `shaper_freq_x` и `shaper_freq_y` будут рассчитаны, вы можете обновить секцию `[input_shaper]` в файле `printer.cfg` с новыми значениями `shaper_freq_x` и `shaper_freq_y`.

### Наращивание давления

Если вы используете функцию Pressure Advance, ее, возможно, придется настроить заново. Следуйте [инструкциям](Pressure_Advance.md#tuning-pressure-advance), чтобы найти новое значение, если оно отличается от предыдущего. Перед настройкой Pressure Advance обязательно перезапустите Klipper.

### Ненадежные измерения частоты звонков

Если вы не можете измерить частоты резонансов, например, если расстояние между колебаниями не стабильно, вы все равно сможете воспользоваться методами формирования входного сигнала, но результаты могут быть не такими хорошими, как при правильном измерении частот, и потребуют немного больше настроек и печати тестовой модели. Обратите внимание, что еще одна возможность - приобрести и установить акселерометр и измерять резонансы с его помощью (см. [docs](Measuring_Resonances.md) с описанием необходимого оборудования и процесса настройки) - но этот вариант требует некоторой обжимки и пайки.

Для настройки добавьте пустой раздел `[input_shaper]` в ваш `printer.cfg`. Затем, предположив, что вы нарезали модель звона с предложенными параметрами, распечатайте тестовую модель 3 раза следующим образом. В первый раз, перед печатью, выполните команду

1. `ЗАПУСК`
1. `SET_VELOCITY_LIMIT MINIMUM_CRUISE_RATIO=0`
1. `SET_PRESSURE_ADVANCE ADVANCE=0`
1. `SET_INPUT_SHAPER SHAPER_TYPE=2HUMP_EI SHAPER_FREQ_X=60 SHAPER_FREQ_Y=60`
1. `TUNING_TOWER COMMAND=SET_VELOCITY_LIMIT PARAMETER=ACCEL START=1500 STEP_DELTA=500 STEP_HEIGHT=5`

и распечатайте модель. Затем снова напечатайте модель, но перед печатью выполните

1. `SET_INPUT_SHAPER SHAPER_TYPE=2HUMP_EI SHAPER_FREQ_X=50 SHAPER_FREQ_Y=50`
1. `TUNING_TOWER COMMAND=SET_VELOCITY_LIMIT PARAMETER=ACCEL START=1500 STEP_DELTA=500 STEP_HEIGHT=5`

Затем распечатайте модель в 3-й раз, но теперь выполните

1. `SET_INPUT_SHAPER SHAPER_TYPE=2HUMP_EI SHAPER_FREQ_X=40 SHAPER_FREQ_Y=40`
1. `TUNING_TOWER COMMAND=SET_VELOCITY_LIMIT PARAMETER=ACCEL START=1500 STEP_DELTA=500 STEP_HEIGHT=5`

По сути, мы печатаем тестовую модель звона с помощью TUNING_TOWER, используя шейпер 2HUMP_EI с shaper_freq = 60 Гц, 50 Гц и 40 Гц.

Если ни одна из моделей не демонстрирует улучшения звонкости, то, к сожалению, не похоже, что методы формирования входного сигнала могут помочь в вашем случае.

В противном случае может оказаться, что все модели не показывают звон, или некоторые показывают звон, а некоторые - не очень. Выберите тестовую модель с самой высокой частотой, которая все еще показывает хорошие улучшения в отношении звона. Например, если модели с частотой 40 и 50 Гц почти не вызывают звона, а модель с частотой 60 Гц уже показывает несколько больший звон, остановитесь на модели с частотой 50 Гц.

Теперь проверьте, будет ли формирователь EI достаточно хорош в вашем случае. Выберите частоту формирователя EI, основываясь на частоте выбранного вами формирователя 2HUMP_EI:

* Для формирователя 2HUMP_EI 60 Гц используйте формирователь EI с shaper_freq = 50 Гц.
* Для формирователя 2HUMP_EI 50 Гц используйте формирователь EI с shaper_freq = 40 Гц.
* Для формирователя 2HUMP_EI 40 Гц используйте формирователь EI с shaper_freq = 33 Гц.

Теперь распечатайте тестовую модель еще раз, выполнив команду

1. `SET_INPUT_SHAPER SHAPER_TYPE=EI SHAPER_FREQ_X=... SHAPER_FREQ_Y=...`
1. `TUNING_TOWER COMMAND=SET_VELOCITY_LIMIT PARAMETER=ACCEL START=1500 STEP_DELTA=500 STEP_HEIGHT=5`

обеспечивая значения shaper_freq_x=... и shaper_freq_y=..., определенные ранее.

Если формирователь EI показывает очень сопоставимые с формирователем 2HUMP_EI хорошие результаты, используйте формирователь EI и определенную ранее частоту, в противном случае используйте формирователь 2HUMP_EI с соответствующей частотой. Добавьте результаты в файл `printer.cfg`, например.

```
[input_shaper]
shaper_freq_x: 50
shaper_freq_y: 50
shaper_type: 2hump_ei
```

Продолжите настройку в разделе [Выбор max_accel](#selecting-max_accel).

## Поиск и устранение неисправностей и часто задаваемые вопросы

### Я не могу получить надежные измерения резонансных частот

Сначала убедитесь, что вместо звона в принтере нет других проблем. Если измерения ненадежны, например, потому, что расстояние между колебаниями не стабильно, это может означать, что принтер имеет несколько резонансных частот на одной оси. Можно попробовать следовать процессу настройки, описанному в разделе [Ненадежные измерения частот звонка](#unreliable-measurements-of-ringing-frequencies), и все же получить что-то от техники формирования входного сигнала. Другая возможность - установить акселерометр, [измерить](Measuring_Resonances.md) резонансы с его помощью и автоматически настроить входной формирователь, используя результаты этих измерений.

### После включения [input_shaper] я получаю слишком сглаженные напечатанные детали, и мелкие детали теряются

Ознакомьтесь с соображениями в разделе [ Selecting max_accel](#selecting-max_accel). Если резонансная частота низкая, не следует устанавливать слишком высокую max_accel или увеличивать параметры square_corner_velocity. Также, возможно, лучше выбрать входные формирователи MZV или даже ZV, а не EI (или формирователи 2HUMP_EI и 3HUMP_EI).

### После успешной печати в течение некоторого времени без звонка он снова появляется

Возможно, что через некоторое время резонансные частоты изменились. Например, возможно, изменилось натяжение ремней (ремни стали более свободными) и т. д. Рекомендуется проверить и повторно измерить резонансные частоты, как описано в разделе [Ringing frequency](#ringing-frequency), и при необходимости обновить файл конфигурации.

### Поддерживается ли установка двух кареток с входными формирователями?

Да. В этом случае необходимо дважды измерить резонансы для каждой каретки. Например, если вторая (сдвоенная) каретка установлена на оси X, можно установить разные входные формирователи для оси X для основной и сдвоенной кареток. Однако входной формирователь для оси Y должен быть одинаковым для обеих кареток (поскольку в конечном итоге эта ось приводится в движение одним или несколькими шаговыми двигателями, каждый из которых получает команду на выполнение одинаковых шагов). Один из вариантов настройки входного формирователя для таких установок - оставить секцию `[input_shaper]` пустой и дополнительно определить секцию `[delayed_gcode]` в файле `printer.cfg следующим образом:

```
[input_shaper]
# Намеренно пустой

[delayed_gcode init_shaper]
начальная_длительность: 0.1
gcode:
  SET_DUAL_CARRIAGE CARRIAGE=1
  SET_INPUT_SHAPER SHAPER_TYPE_X=<dual_carriage_shaper> SHAPER_FREQ_X=<dual_carriage_freq> SHAPER_TYPE_Y=<y_shaper> SHAPER_FREQ_Y=<y_freq>
  SET_DUAL_CARRIAGE CARRIAGE=0
  SET_INPUT_SHAPER SHAPER_TYPE_X=<основная_каретка_шапера> SHAPER_FREQ_X=<основная_каретка_фрека> SHAPER_TYPE_Y=<y_shaper> SHAPER_FREQ_Y=<y_freq>
```

Обратите внимание, что `SHAPER_TYPE_Y` и `SHAPER_FREQ_Y` должны быть одинаковыми в обеих командах. Можно также поместить аналогичный фрагмент в g-код запуска слайсера, однако тогда шейпер не будет включен до тех пор, пока не будет запущена печать.

Обратите внимание, что входной формирователь должен быть настроен только один раз. Последующие изменения кареток или их режимов с помощью команды `SET_DUAL_CARRIAGE` сохранят настроенные параметры входного формирователя.

### Влияет ли input_shaper на время печати?

Нет, функция `input_shaper` сама по себе практически не влияет на время печати. Однако значение параметра `max_accel`, безусловно, влияет (настройка этого параметра описана в [этом разделе](#selecting-max_accel)).

## Технические детали

### Входные формирователи

Формирователи ввода, используемые в Klipper, довольно стандартны, и более подробный обзор можно найти в статьях, описывающих соответствующие формирователи. Этот раздел содержит краткий обзор некоторых технических аспектов поддерживаемых входных формирователей. В таблице ниже приведены некоторые (обычно приблизительные) параметры каждого формирователя.

| Входной <br> формирователь | Формирователь <br> продолжительность | Снижение вибрации 20x <br> (допустимая вибрация 5%) | Снижение вибрации в 10 раз <br> (допустимая вибрация 10%) |
| :-: | :-: | :-: | :-: |
| ZV | 0.5 / shaper_freq | Н/Д | ± 5% shaper_freq |
| MZV | 0.75 / shaper_freq | ± 4% shaper_freq | -10%...+15% shaper_freq |
| ZVD | 1 / shaper_freq | ± 15% shaper_freq | ± 22% shaper_freq |
| EI | 1 / shaper_freq | ± 20% shaper_freq | ± 25% shaper_freq |
| 2HUMP_EI | 1.5 / shaper_freq | ± 35% shaper_freq | ± 40 shaper_freq |
| 3HUMP_EI | 2 / shaper_freq | -45...+50% shaper_freq | -50%...+55% shaper_freq |

Примечание по снижению вибраций: значения в таблице выше являются приблизительными. Если известен коэффициент демпфирования принтера для каждой оси, шейпер можно настроить более точно, и тогда он будет уменьшать резонансы в более широком диапазоне частот. Однако коэффициент демпфирования обычно неизвестен, и его трудно оценить без специального оборудования, поэтому Klipper по умолчанию использует значение 0,1, которое является хорошим универсальным значением. Диапазоны частот в таблице охватывают несколько различных возможных коэффициентов демпфирования вокруг этого значения (примерно от 0,05 до 0,2).

Также обратите внимание, что EI, 2HUMP_EI и 3HUMP_EI настроены на снижение вибраций до 5 %, поэтому значения для 10 % допустимых вибраций приведены только для справки.

**Как использовать эту таблицу:**

* Длительность шейпера влияет на сглаживание в частях - чем она больше, тем более сглаженными получаются части. Эта зависимость не линейна, но может дать представление о том, какие шейперы "сглаживают" больше для одной и той же частоты. Упорядочивание по сглаживанию выглядит следующим образом: ZV < MZV < ZVD ≈ EI < 2HUMP_EI < 3HUMP_EI. Кроме того, для формирователей 2HUMP_EI и 3HUMP_EI редко бывает целесообразно устанавливать shaper_freq = resonance freq (их следует использовать для уменьшения колебаний на нескольких частотах).
* Можно оценить диапазон частот, на которых шейпер снижает вибрации. Например, MZV с shaper_freq = 35 Гц снижает вибрации до 5 % для частот [33,6, 36,4] Гц. 3HUMP_EI с shaper_freq = 50 Гц снижает вибрации до 5 % в диапазоне [27,5, 75] Гц.
* С помощью этой таблицы можно проверить, какой формирователь следует использовать, если нужно уменьшить вибрации на нескольких частотах. Например, если на одной оси есть резонансы на 35 и 60 Гц: a) формирователь EI должен иметь shaper_freq = 35 / (1 - 0,2) = 43,75 Гц, и он будет уменьшать резонансы до 43,75 * (1 + 0,2) = 52. 5 Гц, так что этого недостаточно; б) шейпер 2HUMP_EI должен иметь shaper_freq = 35 / (1 - 0,35) = 53,85 Гц и будет уменьшать колебания до 53,85 * (1 + 0,35) = 72,7 Гц - так что это приемлемая конфигурация. Всегда старайтесь использовать как можно более высокий shaper_freq для данного шейпера (возможно, с некоторым запасом прочности, так что в данном примере лучше всего подойдет shaper_freq ≈ 50-52 Гц), и старайтесь использовать шейпер с как можно меньшей длительностью шейпера.
* Если нужно уменьшить вибрации на нескольких очень разных частотах (скажем, 30 Гц и 100 Гц), может оказаться, что приведенная выше таблица не дает достаточно информации. В этом случае удачнее использовать скрипт [scripts/graph_shaper.py](../scripts/graph_shaper.py), который является более гибким.
