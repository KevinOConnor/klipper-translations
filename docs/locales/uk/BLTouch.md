# BL-Touch

## Підключення BL-Touch

**Попередження** перед тим, як почати: не торкайтеся шпильки BL-Touch голими пальцями, оскільки вона досить чутлива до жиру з пальців. І якщо ви його торкаєтеся, будьте дуже обережні, щоб нічого не зігнути і не штовхнути.

Під’єднайте роз’єм «servo» BL-Touch до `control_pin` відповідно до документації BL-Touch або вашої документації MCU. Використовуючи оригінальну проводку, жовтий дріт від трійки є `control_pin`, а білий дріт від пари — `sensor_pin`. Вам потрібно налаштувати ці контакти відповідно до вашої проводки. Для більшості пристроїв BL-Touch потрібно підтягнути штифт датчика (поставте перед назвою контакту "^"). Наприклад:

```
[bltouch]
 sensor_pin: ^P1.24
 control_pin: P1.26
```

Якщо BL-Touch використовуватиметься для початкової осі Z, тоді встановіть `endstop_pin: probe:z_virtual_endstop` і видаліть `position_endstop` у розділі конфігурації `[stepper_z]`, а потім додайте розділ конфігурації `[safe_z_home]`, щоб підняти вісь z, осі xy, переміщення до центру ліжка та вісь z. Наприклад:

```
[safe_z_home]
 home_xy_position: 100, 100 # Змінити координати на центр вашого друку
 швидкість: 50
 z_hop: 10 # Переміщення вгору на 10 мм
 z_hop_speed: 5
```

Важливо, щоб рух z_hop у safe_z_home був достатньо високим, щоб зонд ні про що не вдарився, навіть якщо штифт зонда перебуває в найнижчому стані.

## Початкові випробування

Перш ніж рухатися далі, переконайтеся, що BL-Touch встановлено на правильній висоті, шпилька повинна бути приблизно на 2 мм вище сопла, коли вона втягнута

Коли ви вмикаєте принтер, щуп BL-Touch повинен виконати самоперевірку і кілька разів перемістити штифт вгору-вниз. Після завершення самоперевірки штифт слід втягнути, а на датчику має засвітитися червоний світлодіод. Якщо є якісь помилки, наприклад, щуп блимає червоним або штифт знаходиться внизу, а не вгорі, вимкніть принтер і перевірте електропроводку та конфігурацію.

Якщо вищевказане виглядає добре, настав час перевірити, чи керуючий штифт працює правильно. Спочатку запустіть `BLTOUCH_DEBUG COMMAND=pin_down` у терміналі вашого принтера. Переконайтеся, що штифт рухається вниз і червоний світлодіод на зонді вимикається. Якщо ні, ще раз перевірте проводку та конфігурацію. Далі введіть `BLTOUCH_DEBUG COMMAND=pin_up`, переконайтеся, що шпилька рухається вгору, а червоне світло знову засвітиться. Якщо він блимає, то виникла якась проблема.

Наступним кроком є перевірка правильності роботи штифта датчика. Запустіть `BLTOUCH_DEBUG COMMAND=pin_down`, переконайтеся, що шпилька рухається вниз, запустіть `BLTOUCH_DEBUG COMMAND=touch_mode`, запустіть `QUERY_PROBE` та переконайтеся, що команда повідомляє "probe: open". Потім, обережно штовхаючи шпильку вгору нігтем пальця, знову запустіть «QUERY_PROBE». Перевірте, чи команда повідомляє "probe: TRIGGERED". Якщо запит не повідомляє правильного повідомлення, це зазвичай вказує на неправильне підключення або конфігурацію (хоча деякі [клони](#bl-touch-clones) можуть вимагати спеціальної обробки). Після завершення цього тесту запустіть `BLTOUCH_DEBUG COMMAND=pin_up` і переконайтеся, що шпилька рухається вгору.

Після завершення перевірки штифта керування BL-Touch і штифта сенсора настав час перевірити зондування, але з особливостями. Замість того, щоб штифт зонда торкався поверхні друку, дайте йому торкнутися нігтя на вашому пальці. Розташуйте інструментальну головку подалі від станини, видайте `G28` (або "PROBE", якщо не використовуєте probe:z_virtual_endstop), зачекайте, доки інструментальна головка почне рухатися вниз, і зупиніть рух, обережно торкнувшись шпильки нігтем. Можливо, вам доведеться зробити це двічі, оскільки стандартна конфігурація самонаведення перевіряє двічі. Будьте готові вимкнути принтер, якщо він не зупиниться, коли ви торкнетеся шпильки.

Якщо це було успішно, виконайте ще один `G28»` (або `PROBE`), але цього разу нехай він торкнеться ліжка, які належить.

## BL-Touch зіпсувався

Коли BL-Touch перебуває в невідповідному стані, він починає блимати червоним. Ви можете змусити його залишити цей стан, виконавши:

BLTOUCH_DEBUG COMMAND=скидання

Це може статися, якщо його калібрування перервано через те, що зонд не може бути витягнутий.

Однак BL-Touch також може більше не мати змоги самостійно калібруватися. Це трапляється, якщо гвинт на його верхній частині знаходиться в неправильному положенні або магнітний сердечник всередині штифта зонда перемістився. Якщо він піднявся так, що прилипає до гвинта, можливо, він більше не зможе опустити свій штифт. При такій поведінці вам потрібно відкрити гвинт і за допомогою кулькової ручки обережно натиснути його на місце. Знову вставте шпильку в BL-Touch так, щоб вона потрапила у витягнуте положення. Обережно відрегулюйте гвинт без головки на місце. Вам потрібно знайти правильне положення, щоб він міг опускати та піднімати шпильку, а червоне світло вмикається та гасне. Для цього використовуйте команди `reset`, `pin_up` і `pin_down`.

## «Клони» BL-Touch

Багато пристроїв-клонів BL-Touch правильно працюють із Klipper, використовуючи конфігурацію за замовчуванням. Однак деякі "клоновані" пристрої можуть не підтримувати команду `QUERY_PROBE`, а деякі "клоновані" пристрої можуть вимагати налаштування `pin_up_reports_not_triggered` або `pin_up_touch_mode_reports_triggered`.

важливо! Не налаштовуйте `pin_up_reports_not_triggered` або `pin_up_touch_mode_reports_triggered` значення False, не дотримуючись цих інструкцій. Не налаштовуйте жодне з цих параметрів на False на оригінальному пристрої BL-Touch. Неправильне встановлення значення False може збільшити час перевірки та збільшити ризик пошкодження принтера.

Деякі "клоновані" пристрої не підтримують `touch_mode`, і в результаті команда `QUERY_PROBE` не працює. Незважаючи на це, за допомогою цих пристроїв все ще можливо виконувати зондування та наведення. На цих пристроях команда `QUERY_PROBE` під час [початкових тестів](#initial-tests) не вдасться, однак наступний `G28` (або `PROBE`) тест є успішним. Можливо, можна використовувати ці "клоновані" пристрої з Klipper, якщо не використовувати команду `QUERY_PROBE` і не ввімкнути функцію `probe_with_touch_mode`.

Деякі пристрої-клони не можуть виконати тест перевірки внутрішнього датчика Klipper. На цих пристроях спроби повернутися додому або зондування можуть призвести до повідомлення Klipper про помилку «BLTouch не вдалося перевірити стан датчика». Якщо це станеться, виконайте вручну кроки, щоб переконатися, що контакт датчика працює, як описано в [розділі початкових тестів](#initial-tests). Якщо команди `QUERY_PROBE` у цьому тесті завжди дають очікувані результати, а помилки «BLTouch не вдалося перевірити стан датчика» все ще виникають, тоді, можливо, необхідно встановити `pin_up_touch_mode_reports_triggered` значення False у конфігураційному файлі Klipper.

Рідкісна кількість старих пристроїв-«клонів» не можуть повідомити, коли вони успішно підняли зонд. На цих пристроях Klipper повідомлятиме про помилку «BLTouch не вдалося підняти зонд» після кожної спроби домашнього або зондового. Можна протестувати ці пристрої: відсуньте голову подалі від ліжка, запустіть `BLTOUCH_DEBUG COMMAND=pin_down`, переконайтеся, що штифт перемістився вниз, запустіть `QUERY_PROBE`, переконайтеся, що команда повідомляє "probe: open", запустіть `BLTOUCH_DEBUG COMMAND=pin_up`, переконайтеся, що шпилька переміщена вгору, і запустіть `QUERY_PROBE`. Якщо штифт залишається піднятим, пристрій не переходить у стан помилки, і перший запит повідомляє «probe: open», тоді як другий запит повідомляє «probe: TRIGGERED», тоді це вказує, що `pin_up_reports_not_triggered` має бути встановлено на False у Klipper конфігураційний файл.

## BL-Touch v3

Для деяких пристроїв BL-Touch v3.0 і BL-Touch 3.1 може знадобитися налаштування `probe_with_touch_mode` у конфігураційному файлі принтера.

Якщо BL-Touch v3.0 має сигнальний дріт, під’єднаний до кінцевого контакту (з конденсатором для фільтрації шуму), тоді BL-Touch v3.0 може не мати змоги постійно надсилати сигнал під час наведення та зондування. Якщо команди `QUERY_PROBE` у [розділі початкових тестів](#initial-tests) завжди дають очікувані результати, але інструментальна головка не завжди зупиняється під час виконання команд G28/PROBE, то це вказує на цю проблему. Обхідним шляхом є встановлення `probe_with_touch_mode: True` у файлі конфігурації.

BL-Touch v3.1 може неправильно перейти в стан помилки після успішної спроби зонду. Симптомами є час від часу миготливе світло на BL-Touch v3.1, яке триває кілька секунд після успішного контакту з ліжком. Klipper має очистити цю помилку автоматично, і це, як правило, нешкідливо. Однак можна встановити `probe_with_touch_mode` у файлі конфігурації, щоб уникнути цієї проблеми.

важливо! Деякі пристрої-клони та BL-Touch версії 2.0 (і раніших) можуть мати знижену точність, якщо для параметра `probe_with_touch_mode` встановлено значення True. Встановлення значення True також збільшує час, необхідний для розгортання зонда. Якщо налаштовуєте це значення на «клоні» або старішому пристрої BL-Touch, обов’язково перевірте точність датчика до та після встановлення цього значення (для перевірки використовуйте команду `PROBE_ACCURACY`).

## Багаторазове зондування без укладання

За замовчуванням Klipper розгортатиме зонд на початку кожної спроби зонду, а потім зберігатиме зонд. Таке повторюване розгортання та зберігання зонда може збільшити загальний час послідовності калібрування, яка включає багато вимірювань зонда. Klipper підтримує залишення зонда розгорнутим між послідовними зондами, що може зменшити загальний час зондування. Цей режим можна ввімкнути, налаштувавши для `stow_on_each_sample` значення False у файлі конфігурації.

важливо! Встановлення `stow_on_each_sample` на False може призвести до того, що Klipper здійснюватиме горизонтальні рухи інструментальної головки під час розгортання зонда. Обов’язково переконайтеся, що всі операції зондування мають достатній зазор Z, перш ніж установлювати значення False. Якщо вільного простору недостатньо, горизонтальне переміщення може призвести до того, що шпилька зачепиться за перешкоду та призведе до пошкодження принтера.

важливо! Рекомендується використовувати `probe_with_touch_mode`, налаштований на True, коли використовується `stow_on_each_sample`, налаштований на False. Деякі пристрої-клони можуть не виявляти наступного контакту з ліжком, якщо `probe_with_touch_mode` не встановлено. На всіх пристроях використання комбінації цих двох налаштувань спрощує сигналізацію пристрою, що може покращити загальну стабільність.

Однак зауважте, що деякі пристрої-клони та BL-Touch версії 2.0 (і раніших) можуть мати знижену точність, якщо для параметра `probe_with_touch_mode` встановлено значення True. На цих пристроях доцільно перевірити точність датчика до та після налаштування `probe_with_touch_mode` (для перевірки використовуйте команду `PROBE_ACCURACY`).

## Калібрування зсувів BL-Touch

Дотримуйтеся вказівок у посібнику [Probe Calibrate](Probe_Calibrate.md), щоб установити параметри конфігурації x_offset, y_offset і z_offset.

Бажано переконатися, що зсув Z близький до 1 мм. Якщо ні, то ви, ймовірно, захочете перемістити зонд вгору або вниз, щоб виправити це. Ви хочете, щоб він спрацьовував задовго до того, як сопло вдариться про ложе, щоб можливе застрягнення нитки розжарення або деформоване ложе не вплинуло на будь-яку дію зонду. Але в той же час ви хочете, щоб втягнуте положення було якнайвище над соплом, щоб воно не торкалося надрукованих частин. Якщо було зроблено коригування положення зонда, повторіть кроки калібрування зонда.

## Режим виведення BL-Touch

* BL-Touch V3.0 підтримує налаштування вихідного режиму 5 В або OPEN-DRAIN, BL-Touch V3.1 також підтримує це, але також може зберігати це у своєму внутрішньому EEPROM. Якщо для вашої плати контролера потрібен фіксований високий логічний рівень 5 В для режиму 5 В, ви можете встановити параметр «set_output_mode» у розділі [bltouch] файлу конфігурації принтера на «5 В».

   *** Використовуйте режим 5 В, лише якщо вхідна лінія плат контролера допускає 5 В. Ось чому стандартною конфігурацією цих версій BL-Touch є режим OPEN-DRAIN. Ви можете потенційно пошкодити процесор плати контролера ***

   Тому: якщо платі контролера ПОТРІБЕН режим 5 В І вона терпима до 5 В на лінії вхідного сигналу І якщо

   - у вас є BL-Touch Smart V3.0, вам потрібно використовувати параметр «set_output_mode: 5V», щоб забезпечити це налаштування під час кожного запуску, оскільки зонд не може запам’ятати потрібне налаштування.
   - у вас є BL-Touch Smart V3.1, у вас є вибір між використанням «set_output_mode: 5V» або одноразовим збереженням режиму за допомогою команди «BLTOUCH_STORE MODE=5V» вручну і НЕ використовуючи параметр «set_output_mode:».
   - у вас є якийсь інший датчик: деякі датчики мають слід на друкованій платі, який потрібно вирізати, або перемичку, яку потрібно встановити, щоб (назавжди) встановити вихідний режим. У цьому випадку повністю пропустіть параметр set_output_mode.
Якщо у вас V3.1, не автоматизуйте та не повторюйте збереження режиму виведення, щоб уникнути зношування EEPROM датчика. BLTouch EEPROM здатний приблизно на 100 000 оновлень. 100 магазинів на день додали б до приблизно 3 років роботи до того, як він зношується. Таким чином, збереження вихідного режиму у V3.1 розроблено постачальником як складна операція (заводськими налаштуваннями за замовчуванням є безпечний режим OPEN DRAIN) і не підходить для повторного запуску будь-яким роздільником, макросом або будь-яким іншим, це бажано використовувати лише під час першого інтегрування зонда в електроніку принтера.
