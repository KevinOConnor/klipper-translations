# КАНБУС

Цей документ описує підтримку автобусів Klipper's CAN.

## Обладнання для пристроїв

Klipper в даний час підтримує CAN на stm32, SAME5x і rp2040 чіпси. Крім того, мікроконтролерний чіп повинен бути на дошці, яка має CAN-транзивер.

Щоб компілювати для CAN, запустіть `make менюconfig` і виберіть "CAN bus" як інтерфейс зв'язку. Нарешті, компіляйте код мікроконтролера і перемішайте його на цільову дошку.

## Хост обладнання

Для того, щоб використовувати автобус CAN, необхідно мати перехідник. Рекомендується використовувати адаптер "USB до CAN". Є багато різних адаптерів USB до CAN, доступних з різних виробників. При виборі одного ми рекомендуємо переконатися, що прошивку можна оновити на ньому. (На жаль, ми знайшли деякі адаптери USB, що працюють з дефектною прошивкою і закривається вниз, тому перевірте перед покупкою.) Дивитися адаптери, які можуть запустити Klipper безпосередньо (в його "USB до CAN мостового режиму") або запустити [свічник прошивку](https://github.com/candle-usb/candleLight_fw).

Також необхідно налаштувати операційну систему хосту для використання адаптера. Це, як правило, робиться шляхом створення нового файлу `/etc/network/interfaces.d/can0` з наступним вмістом:

```
hYIP и SSL
iface can0 може стати статичним
бітрейт 1000000
ip посилання набір $IFACE txqueuelen 128
```

## Резистори

Автобус CAN повинен мати два 120 ohm резистори між проводами CANH та CANL. В ідеалі один резистор розташований на кожному кінці автобуса.

Зверніть увагу, що деякі пристрої мають вбудований 120 ohm резистор, який не можна легко видалити. Деякі пристрої не включають резистор. Інші пристрої мають механізм вибору резистора (типово, з'єднуючи «шпильковий стрибок»). Обов'язково перевірте схеми всіх пристроїв на автобусі CAN, щоб переконатися, що на автобусі є два і тільки два 120 Ом резистори.

Щоб перевірити, що резистори правильні, можна видалити живлення на принтер і використовувати багатометр для перевірки опору між дротами CANH і CANL - він повинен повідомити ~60 омів на правильно проведеному автобусі CAN.

## Пошук каналів_uid для нових мікроконтролерів

Кожен мікроконтролер на автобусі CAN призначений унікальним ідентифікатором на основі фабричного ідентифікатора чіпа, що зашифровується в кожен мікроконтролер. Щоб знайти кожен пристрій мікроконтролера id, переконайтеся, що апарат працює і проводжається правильно, а потім запустити:

```
~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0
```

Якщо неініціалізовані пристрої CAN виявлені вище командні рядки, такі як:

```
Знайдено canbus_uid=11aa22bb33cc, Застосування: Клиппер
```

Кожен пристрій має унікальний ідентифікатор. У наведеному вище прикладі `11aa22bb33cc` є мікроконтролером "канбус_uuid".

Зауважте, що `canbus_query.py` інструмент буде звітувати тільки неініціалізовані пристрої - якщо Klipper (або аналогічний інструмент) налаштовує пристрій, потім він більше не з'явиться в списку.

## Налаштування кліппера

Оновлення конфігурації Klipper [mcu](Config_Reference.md#mcu) для використання автобуса CAN для спілкування з пристроєм - наприклад:

```
[mcu my_can_mcu]
javascript licenses api веб-сайт go1.13.8
```

## USB до CAN автобусний міст режим

Деякі мікроконтролери підтримують вибір "USB до CAN автобусного мосту" в режимі "під ключ". Цей режим може дозволити одному використовувати мікроконтролер як "USB до CAN адаптера" і як вузол Klipper.

Коли Klipper використовує цей режим мікроконтролер з'являється як "USB CAN адаптер" під Linux. "Klipper Bridge mcu" себе з'явиться, якби він був на цьому автобусі CAN - він може бути ідентифікований через `canbus_query.py` і він повинен бути налаштований як інші CAN автобуси Klipper вузлів.

Деякі важливі ноти при використанні цього режиму:

* Для спілкування з автобусом необхідно налаштувати інтерфейс `can0` (або аналогічний) Тим не менш, швидкість автобуса Linux CAN і параметри біт-часів CAN ігноруються Klipper. В даний час частота автобуса CAN вказана під час "налаштування меню" та швидкості автобуса, зазначеної в Linux ігнорується.
* Після того, як "містечко" скидається, Linux буде відключати відповідний інтерфейс `can0`. Щоб забезпечити належне обслуговування команд FIRMWARE_RESTART та RESTART, рекомендується використовувати `allow-hotplug` в `/etc/network/interfaces.d/can0` файл. Наприклад:

```
hYIP и SSL
iface can0 може стати статичним
бітрейт 1000000
ip посилання набір $IFACE txqueuelen 128
```

* На автобусі CAN не існує жодних труднощів. Повідомлень і з мостового маку не будуть бачити інші адаптери, які можуть бути на автобусі CAN.
* Доступна пропускна здатність як до «місто-мку» і всіх пристроїв на автобусі CAN ефективно обмежена частотою автобуса CAN. В результаті рекомендується використовувати автобусну частоту CAN 1000000 при використанні "USB в CAN режимом мосту".

   Навіть при частоті автобуса CAN 1000000, може бути недостатньою пропускною здатністю для запуску `SHAPER_CALIBRATE` тест, якщо обидва кроки XY і акселерометр всі спілкуються по одному інтерфейсу "USB до CAN".
* USB до CAN мостової дошки не з'явиться як послідовний пристрій USB, він не покаже при роботі `ls /dev/serial/by-id`, і він не може бути налаштований у принтері Klipper.cfg з параметром `серіал:`. Мостова дошка з'являється як "USB CAN адаптер" і налаштовується в принтері.cfg як [CAN node](#configuring-klipper).

## Поради щодо усунення несправностей

Дивитися [CAN busshooting](CANBUS_Troubleshooting.md) документ.
