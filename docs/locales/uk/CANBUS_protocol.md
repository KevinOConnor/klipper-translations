# Протокол CANBUS

У цьому документі описано протокол, який Klipper використовує для зв’язку через [шину CAN](https://en.wikipedia.org/wiki/CAN_bus). Перегляньте <CANBUS.md> для отримання інформації про налаштування Klipper з CAN-шиною.

## Мікроконтролер id призначення

Klipper використовує лише стандартні пакети CAN 2.0A, які обмежені 8 байтів даних та ідентифікатором 11-bit CAN. Для забезпечення ефективної комунікації кожен мікроконтролер присвоюється в режимі реального часу унікальна 1-byte CAN bus nodeid (`canbus_nodeid`) для загального командного та зворотного трафіку. Командні повідомлення Klipper, що йдуть від господаря до мікроконтролера, використовують автобус CAN id `canbus_nodeid * 2 + 256`, в той час як відповіді Klipper від мікроконтролера для використання `canbus_nodeid * 2 + 256 + 1`.

Кожен мікроконтролер має завод, призначену для ідентифікації мікроелементів, який використовується при наданні допомоги. Цей ідентифікатор може перевищувати довжину одного пакета CAN, тому функція хешу використовується для створення унікальної 6-байтної id (`canbus_uuid`) з заводської id.

## Повідомлення адміністратора

Повідомлення адміністратора використовуються для надання допомоги. Повідомлення адміністратора, надіслані з хосту до мікроконтролера, використовують ідентифікатор автобуса CAN `0x3f0` і повідомлення, надіслані з мікроконтролера, щоб запускати використання автобуса CAN `0x3f1`. Всі мікроконтролери слухають повідомлення про id `0x3f0`; які id можуть бути думаними як "розкладна адреса".

### CMD_QUERY_UNASSIGNed повідомлення

Ця команда запитує всіх мікроконтролерів, які ще не були призначені `canbus_nodeid`. Непризначені мікроконтролери відповідають повідомлення про відповідь RESP_NEED_NODEID.

Формат повідомлення CMD_QUERY_UNASSIGNED: `<1-byte message_id = 0x00>`

### CMD_SET_KLIPPER_NODEID повідомлення

Ця команда призначає `canbus_nodeid` до мікроконтролера з наданою `canbus_uuid`.

CMD_SET_KLIPPER_NODEID Формат повідомлення: `<1-byte повідомлення_id = 0x01><6-byte canbus_uid><1-byte canbus_nodeid>`

### РЕЗУЛЬТАТИ повідомлення

РЕСП_НЕДИД Формат повідомлення: `<1-byte повідомлення_id = 0x20><6-byte canbus_uid><1-byte set_klipper_nodeid = 0x01>`

## Пакети даних

Мікроконтролер, який був призначений для використання вузла через команду CMD_SET_KLIPPER_NODEID, може надсилати та отримувати пакети даних.

Пакетні дані в повідомленнях за допомогою отриманого автобуса CAN (`canbus_nodeid * 2 + 256`) просто додаються до буферу, а при повному [mcu повідомлення протоколу](Protocol.md) знайдено його вміст, принесені і обробляються. Дані обробляються як байтовий потік - немає вимог до запуску блоку повідомлення Klipper, щоб вирівняти з стартом пакету CAN.

Аналогічно, відповідь на повідомлення про протокол МКУ відправляється з мікроконтролера, щоб перевірити дані повідомлення в один або більше пакетів з передаванням вузлів CAN автобусом (`canbus_nodeid * 2 + 256 + 1`).
