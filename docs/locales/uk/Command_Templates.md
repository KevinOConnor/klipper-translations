# Шаблони команд

Цей документ надає інформацію про імплементацію команд G-Code в gcode_macro (і аналогічні) розділах налаштувань.

## G Code Macro Naming

Корпус не важливий для ім'я макросу G-Code - MY_MACRO і my_macro будуть оцінювати однакові і можуть бути викликані у верхній або нижній корпусі. Якщо будь-які номери використовуються в макросі, то вони повинні бути в кінці назви (наприклад, TEST_MACRO25 діє, але MACRO25_TEST3 не є).

## Форматування G-Code в конфігурації

Визначення макросу в файлі конфігурації. Щоб вказати багатолінійну послідовність G-Code, важливо для кожної лінії, щоб мати належне відступання. Наприклад:

```
[gcode_macro blink_led]
гкод:
СЕТ_ПІН ПІН=my_led VALUE=1
Г4 П2000
СЕТ_ПІН ПІН=my_led VALUE=0
```

Зверніть увагу, як `gcode:` опція налаштування завжди починається на початку лінії та наступних ліній в макросах G-Code ніколи не стартує на початку.

## Додати опис до макросу

Для визначення функціональності можна додати короткий опис. Додати `опис:` з коротким текстом для опису функціональності. За замовчуванням "G-Code макрос" якщо не вказано. Наприклад:

```
[gcode_macro blink_led]
опис: Blink my_led раз
гкод:
СЕТ_ПІН ПІН=my_led VALUE=1
Г4 П2000
СЕТ_ПІН ПІН=my_led VALUE=0
```

Термінал буде відображати опис, коли ви використовуєте команду `HELP` або функцію автоматичного завершення.

## Зберегти/відновити стан для G-Code переміщення

На жаль, мова команди G-Code може бути складним для використання. Стандартний механізм переміщення ключа інструменту через команду `G1` (`G0` команди є псевдонімом для `G1` і його можна використовувати з ним. Тим не менш, ця команда спирається на налаштування "G-Code parsing State" `M82`, `M83`, `G90`, `G91`, `G92`, а попередній `G1` команди. При створенні G-Code макросу це гарна ідея, щоб завжди явно встановити стан парсингу G-Code до видачі команди `G1`. `G1` команда зробить небажаний запит.)

`G1` переходить в `SAVE_GCODE_STATE`, `G91`, і `RESTORE_GCODE_STATE`. Наприклад:

```
[gcode_macro MOVE_UP]
гкод:
SAVE_GCODE_STATE NAME=my_move_up_state
Г91
Г1 З10 Ф300
РЕСТОР_GCODE_STATE NAME=my_move_up_state
```

`G91` команди розміщує стан парсингу G-Code в "реативний режим руху" і `RESTORE_GCODE_STATE` відновлює стан до того, що було до введення макросу. Обов'язково вказати точну швидкість (через параметр `F`) на першому `G1`.

## Розширення шаблону

Gcode_macro `gcode:` config розділу оцінюється за допомогою мови шаблона Jinja2. Можна оцінити вирази в режимі run-time, загортаючи їх в `{ }` символи або використовувати умовні вирази, загорнуті `{% %}`. Дивитися [Jinja2 документації](http://jinja.pocoo.org/docs/2.10/templates/) для подальшої інформації про синтаксису.

Приклад комплексного макросу:

```
[gcode_macro clean_nozzle]
гкод:
0 товар(ов) - 0.00 р.
SAVE_GCODE_STATE NAME=clean_nozzle_state
Г90
Г0 З15 Ф300
{% для протирати в діапазоні(wipe_count) %}
{% за координацію [(275, 4),(235, 4)] %}
G0 X{координат[0]} Y{координат }} + 0.25 * знищити} Z9.7 F12000
0 товар(ов) - 0.00 €
0 товар(ов) - 0.00 €
РЕСТОР_GCODE_STATE NAME=clean_nozzle_state
```

### Параметри Macro

Часто корисно для інспектування параметрів, що надходять до макросу, коли його називають. Ці параметри доступні за допомогою `params` псевдоваріант. Наприклад, якщо макрос:

```
[gcode_macro SET_PERCENT]
гкод:
М117 Тепер в { парам. VALUE Товарів у наявності: 100
```

`SET_PERCENT VALUE=.2` оцінюватиме `M117 тепер на 20%`. Зауважте, що імена параметра завжди знаходяться у верхньому рядку, коли оцінюється в макрос і завжди проходять як рядки. Якщо ви виконуєте математику, то вони повинні бути явно перетворені на цілі або плавати.

Jinja2 `set` для використання параметра за замовчуванням і призначити результат локального імені. Наприклад:

```
[gcode_macro SET_BED_TEMPERATURE]
гкод:
{% встановити ліжко_temp = парам. ТЕМПЕРАТУРА ВИСТАВКИ (40) АДРЕСА %}
М140 S{bed_temp}
```

### Змінна "rawparams"

Повні непаровані параметри для запуску макросу можна отримати за допомогою `rawparams` псевдоваріативно.

Зверніть увагу, що це буде містити будь-які коментарі, які були частиною оригінальної команди.

Перегляньте файл [sample-macros.cfg](../config/sample-macros.cfg) для прикладу, у якому показано, як замінити команду `M117` за допомогою `rawparams`.

### «принтер» Сортування

Ви можете перевірити (і змінити) поточний стан принтера за допомогою `printer` псевдо-варіативний. Наприклад:

```
[gcode_macro повільно_fan]
гкод:
M106 S{ принтер.fan.speed * 0.9 * 255}
```

Доступні поля визначені в документі [Status Reference](Status_Reference.md).

Головна Макрос вперше оцінюється в повноті і тільки потім є виконані команди. Якщо макросхеми, команда, яка змінює стан принтера, результати зміни стану не буде видно під час оцінювання макросу. Це також може призвести до тонкої поведінки, коли макрогенерує команди, які викликають інші макроси, оскільки називається макрос оцінюється, коли це викликається (який після всієї оцінки вихідного макросу).

`printer` – назва розділу налаштування. Наприклад, `printer.fan` відноситься до об'єкту вентилятора, створеного розділом `[fan]`. Є деякі винятки цього правила - можливо, `gcode_move` і `toolhead` об'єкти. Якщо в розділі налаштування містяться місця в ній, то можна отримати доступ до неї за допомогою `` accessor - наприклад: `printer["generic_heater my_chamber_heater"]. Температурна`.

Зверніть увагу, що Jinja2 `set` директива може призначити локальну назву об'єкту в `printer` ієрархії. Це може зробити макроси більш читабельним і зменшити типування. Наприклад:

```
[gcode_macro QUERY_HTU21D]
гкод:
{% встановлений датчик = принтер["htu21d my_sensor"] %}
М117 Темп: КСНУМКС Вологість:{sensor.humidity}
```

## Дії

Ви можете змінити стан принтера. Наприклад, `{ action_emergency_stop() }` призведе до того, що принтер переходить в стан відключення. Зверніть увагу, що ці дії беруться в той час, що макро оцінюється, що може бути значною кількістю часу перед створеними командами g-коду.

Доступні команди "action":

- `action_respond_info(msg)`: Напишіть надану `msg` в /tmp/printer псевдонімом. Кожна лінія `msg` буде відправлена з "//" префіксом.
- `action_raise_error(msg)`: Визначте поточний макрос (і будь-які виклики макрос) і напишіть на дану `msg` в /tmp/printer псевдо-термінал. Перша лінія `msg` буде відправлена з "!!" префікс і наступні лінії будуть мати "//" префікс.
- `action_emergency_stop(msg)`: Перехід принтера до стану відключення. `msg` параметр необов'язково, він може бути корисний для опису причин для відключення.
- `action_call_remote_method(method_name)`: Викликає метод, зареєстрований віддаленим клієнтом. Якщо метод приймає параметри, які вони повинні бути надані через ключові аргументи, тобто: `action_call_remote_method("print_stuff", my_arg="hello_world")`

## Сортування

SET_GCODE_VARIABLE Команда може бути корисною для збереження стану між макро дзвінками. Змінні імена не містять символів верхнього корпусу. Наприклад:

```
[gcode_macro start_probe]
JavaScript licenses API Веб-сайт Go1.13.8
гкод:
# Збережіть цільову температуру в ліжко_temp змінна
SET_GCODE_VARIABLE MACRO=start_probe VARIABLE=bed_temp VALUE={printer.heater_bed.target}
# Вимкнений обігрівач
М140
# Виконувати зонд
ПРОБЛЕ
# Call end_probe макроси при завершенні зонду
JavaScript licenses API Веб-сайт

[gcode_macro end_probe]
гкод:
# Температура відновлення
M140 S{printer["gcode_macro start_probe"]. ліжко_temp}
```

При використанні SET_ обов'язково врахувати терміни макрооцінки та виконання команд врахувати при використанні SET_ GCODE_VARIABLE.

## Випробувано Gcodes

Параметри конфігурації [delayed_gcode] можна використовувати для виконання послідовності затримки gcode:

```
[delayed_gcode clear_display]
гкод:
М117

[gcode_macro load_filament]
гкод:
Г91
Г1 Е50
Г90
М400
M117 Навантаження завершено!
ОНОВЛЕННЯ_DELAYED_GCODE Ім'я користувача ДЮРАЦІЯ=10
```

Коли `load_filament` макро вище виконань, він буде відображати повідомлення "Завантажити повну!" після завершення екструзії. Остання лінія gcode дозволяє "clear_display" затримувати_gcode, встановити для виконання за 10 секунд.

`initial_duration` параметр налаштування може бути встановлений для виконання затриманого_gcode на принтері. Відлік починається, коли принтер надходить в стан "читця". Наприклад, нижче затриманий_gcode буде виконувати 5 секунд після того, як принтер готовий, ініціалізація дисплея з повідомленням "Welcome!":

```
[вітаємо з відкладеним_gcode]
 початкова_тривалість: 5.
 gcode:
   M117 Ласкаво просимо!
```

Його можливо для затримки gcode для повторення шляхом оновлення параметра gcode:

```
[delayed_gcode report_temp]
початковий_duration: 2,2 км
гкод:
{action_respond_info("Extruder Temp: %.1f" % (printer.extruder0. Температура)
ОНОВЛЕННЯ_DELAYED_GCODE ID=report_temp ДЮРАЦІЯ=2
```

Над затримкою_gcode надішлемо "// Extruder Temp: [ex0_temp]" до Octoprint кожні 2 секунди. Це може бути скасовано з наступним gcode:

```
ОНОВЛЕННЯ_DELAYED_GCODE ID=report_temp ДЮРАЦІЯ=0
```

## Шаблони меню

Якщо [розділ конфігурації дисплея](Config_Reference.md#display) увімкнено, то можна налаштувати меню за допомогою розділів конфігурації [меню](Config_Reference.md#menu).

У шаблонах меню доступні наступні атрибути:

* `menu.width` - ширина елемента (номер стовпчиків відображення)
* `menu.ns` - простір назв елемента
* `menu.event` - назва події, яка запустив сценарій
* `menu.input` - значення вводу, доступна тільки в контексті скрипта введення

У шаблонах меню доступні наступні дії:

* `menu.back(сила, оновлення)`: буде виконувати команду меню, додаткові параметри болеан `<force>` і `<update>`.
   * Коли `<force>` встановлюється Далі він також зупинить редагування. За замовчуванням значення False.
   * Коли `<update>` встановлюється False потім батьківські контейнерні елементи не оновлено. Ім'я користувача.
* `menu.exit(force)` - виконувати команду виходу меню, додатковий параметр boolean `<force>` значення за замовчуванням False.
   * Коли `<force>` встановлюється Далі він також зупинить редагування. За замовчуванням значення False.

## Збережіть Варіабельні диски

Якщо ввімкнено розділ конфігурації [save_variables](Config_Reference.md#save_variables), `SAVE_VARIABLE VARIABLE=<name> VALUE=<value>` можна використовувати для збереження змінної диску, щоб його можна використовувати у перезавантаженнях. Всі збережені змінні навантажуються в `printer.save_variables.variables` dict при запуску і може бути використаний в gcode макрос. Щоб уникнути зайвих довгих ліній можна додати наступні вгорі макроси:

```
{% встановити svv = принтер.save_variables.variables %}
```

Як приклад, його можна використовувати для збереження стану 2-в-1-вихідного гарячика і при запуску друку, що використовується активний екструдера, замість T0:

```
[gcode_macro T1]
гкод:
ACTIVATE_EXTRUDER extruder=extruder1
SAVE_VARIABLE VARIABLE=currentextruder VALUE="extruder1" Р

[gcode_macro T0]
гкод:
ACTIVATE_EXTRUDER JavaScript licenses API Веб-сайт Go1.13.8
SAVE_VARIABLE VARIABLE=currentextruder VALUE='"extruder" Р

[gcode_macro START_GCODE]
гкод:
{% встановити svv = принтер.save_variables.variables %}
ACTIVATE_EXTRUDER extruder={svvv.currentextruder}
```
