# Розгортання

Цей документ описує деякі інструменти для відключення кліппера.

## Запуск регресивних випробувань

Головний репозиторій Klipper GitHub використовує "github дії" для запуску серії регресивних тестів. Це може бути корисним для того, щоб запустити деякі ці тести локально.

Введіть номер мобільного, який Ви вказали при укладаннi договору з банком - для ідентифікації:

```
./scripts/Check_whitespace.sh
```

Тест-пакет Klippy вимагає "Дика даних" від багатьох платформ. Найпростіший спосіб отримати їх можна [завантажити їх з github](https://github.com/Klipper3d/klipper/products/1438). Після того, як завантажуються дані, скористайтеся наступним чином, щоб запустити вихідний пакет:

```
tar xfz klipper-dict-20 ???????????????.tar.gz
~/klippy-env/bin/python ~/klipper/scripts/test_klippy.py -d дикт/ ~/klipper/test/klippy/*.test
```

## Ручна відправка команд до мікроконтролера

Нормально, хост кліппи. py процес буде використовуватися для перекладу команд gcode до команди мікроконтролерів Klipper. Тим не менш, можна вручну надсилати ці команди МКУ (функції, позначені макросом DECL_COMMAND() у коді джерела Klipper). Для цього запустіть:

```
~/klippy-env/bin/python ./klippy/console.py/tmp/pseudoserial
```

Переглядайте команду "HELP" в інструменті для отримання додаткової інформації про його функціонал.

Деякі параметри командного рядка доступні. Для отримання додаткової інформації запустіть: ` ~/klippy-env/bin/python ./klippy/console.py --help`

## Перевантаження файлів gcode до команд мікроконтролера

Код хосту Klippy може працювати в пакетному режимі, щоб виробляти команди мікроконтролера низького рівня, пов'язані з файлом gcode. Перевірка цих низькорівневих команд корисно при спробі зрозуміти дії апаратного забезпечення низького рівня. Також можна порівняти різницю в командах мікроконтролерів після зміни коду.

Для запуску Klippy в цьому пакетному режимі існує один крок, необхідний для створення мікроконтролера " словник даних". Це зроблено шляхом складання мікроконтролюючого коду для отримання **out/klipper.dict** файл:

```
налаштування меню
зроби
```

Після того, як вище зроблено, можна запустити Klipper в пакетному режимі (див. [installation](Installation.md) для кроків, необхідних для побудови python віртуального середовища і принтера.cfg файл):

```
~/klippy-env/bin/python ./klippy/klippy.py ~/printer.cfg -i тест.gcode -o тест. -v -d/klipper.dict
```

Надійшла файл **test.serial** з бінарним серійним виходом. Цей вихід може бути перекладений для читання тексту з:

```
~/klippy env/bin/python ./klippy/parsedump.py out/klipper.dict test.serial > test.txt
```

Отриманий файл **test.txt** містить читальний список команд мікроконтролера.

Пакетний режим відключає певну відповідь / команду запитів для функції. В результаті будуть деякі відмінності між фактичними командами і вище виходом. Згенеровані дані корисні для тестування та перевірки; не корисно для відправки в реальний мікроконтролер.

## Аналіз та аналіз даних

Кліппер зберігає історію внутрішнього руху, яка може бути пізніше проаналізована. Щоб скористатися цією функцією, Klipper повинен бути запущений з [API сервер](API_Server.md) включений.

Увімкнення даних увімкнено `data_logger.py` інструментом. Наприклад:

```
javascript licenses api веб-сайт go1.13.8 /tmp/klippy_uds mylog
```

Ця команда буде підключена до сервера Klipper API, підписатися на інформацію про стан та рух, а також записувати результати. Два файли створюються - стиснений файл даних і індексний файл (наприклад, `mylog.json.gz` і `mylog.index.gz`. Після запуску залоги можна завершити друку і інші дії - заправка буде продовжуватися на фоні. Коли це зроблено журнал, натисніть `ctrl-c`, щоб вийти з `data_logger.py` інструмент.

Отримані файли можна прочитати і розрахувати за допомогою інструменту `motan_graph.py`. Для створення графіків на Малиновій Пі необхідно встановити пакет «матплотин»:

```
sudo apt-get оновлення
sudo apt-get встановити python-matplotlib
```

Тим не менш, це може бути зручніше скопіювати файли даних в машині для настільного комп'ютера поряд з кодом Python в каталозі `scripts/motan/`. Скрипки аналізу руху повинні працювати на будь-якій машині з останню версію [Python](https://python.org) і [Matplotlib](https://matplotlib.org/) встановлених.

Графіки можна створювати за допомогою команди:

```
~/klipper/scripts/motan/ motan_graph.py mylog -o mygraph.png
```

Один може використовувати параметр `-g`, щоб вказати дані до графіка (це займає літера Python, що містить список списків). Наприклад:

```
~/klipper/scripts/motan/motan_graph.py mylog -g "[["trapq(toolhead,velocity)"], ["trapq(toolhead,accel)"]] р
```

Перелік доступних даних можна знайти за допомогою параметра `-l` - наприклад:

```
~/klipper/scripts/motan/ motan_graph.py -l
```

Також можна вказати параметри матоплотліба для кожного набору даних:

```
~/klipper/scripts/motan/motan_graph.py mylog -g "[["trapq(toolhead,velocity)?color=red&alpha=0.4"]] р
```

Багато варіантів матоплотліба доступні; деякі приклади - "колір", "лабор", "alpha", "linestyle".

Інструмент `motan_graph.py` підтримує кілька інших параметрів командного рядка - використовуйте параметр `--help`, щоб переглянути список. Також може бути зручно переглянути/змінити сам сценарій [motan_graph.py](../scripts/motan/motan_graph.py).

Сирі журнали даних, що виробляються `data_logger.py` інструмент слідувати за форматом, описаним в [API Server](API_Server.md). Це може бути корисним для перегляду даних з командуванням Unix, таких як: `gunzip < mylog.json.gz tr '\03' '\n' `

## Формування графіків навантаження

Файл журналу Klippy (/tmp/klippy.log) зберігає статистику на пропускній здатності, навантаження мікроконтролера та навантаження на буфер. Надрукуйте цю статистику.

Для створення графіка необхідно встановити пакет «матплотліб»:

```
sudo apt-get оновлення
sudo apt-get встановити python-matplotlib
```

Потім графіки можуть бути виготовлені з:

```
javascript licenses api веб-сайт go1.13.8 javascript licenses api веб-сайт go1.13.8
```

Потім можна переглянути отриманий **loadgraph.png** файл.

Виготовлені різні графіки. `~/klipper/scripts/graphstats.py --help`

## Вилучення інформації з кліппи. Лог файл

Файл журналу Klippy (/tmp/klippy.log) також містить інформацію про видалення. Є логекстракт. py скрипт, який може бути корисний при аналізі відключення мікроконтролерів або аналогічної проблеми. Це зазвичай працює з тим, що:

```
mkdir work_directory
cd work_directory
javascript licenses api веб-сайт go1.13.8
javascript licenses api веб-сайт go1.13.8
```

Скрипт буде витягти файл налаштування принтера і буде витягувати інформацію про вимкнення MCU. Інформація про відключення від MCU (за наявності) буде направлена на своєчасну допомогу при діагностуванні причин і сценаріїв впливу.

## Тестування з simulavr

Інструмент [simulavr](http://www.nongnu.org/simulavr/) дозволяє змоделювати мікроконтролер Atmel ATmega. Цей розділ описує, як можна запустити тестові файли gcode через simulavr. Рекомендовано запустити це на машині для настільного комп'ютера (не малиновий Пі), оскільки він вимагає значного cpu, щоб ефективно працювати.

Для використання simulavr, завантажити пакет simulavr і компілювати з підтримкою python. Зауважте, що система побудови може мати деякі пакети (наприклад, перемикач), встановлені для того, щоб побудувати модуль python.

```
git clone git://git.savannah.nongnu.org/simulavr.git
cd simulavr
зробити пітон
зробити будівництво
```

Переконайтеся, що файл, як **./build/pysimulavr/_pysimulavr.*.so** присутній після вищезгаданого збірника:

```
лс ./build/pysimulavr/_pysimulavr.*.so
```

Ця команда повинна повідомити конкретний файл (наприклад, **./build/pysimulavr/_pysimulavr.cpython-39-x86_64-linux-gnu.so**) і не помилитися.

Якщо ви перебуваєте на системі Debian (Debian, Ubuntu і т.д.) ви можете встановити наступні пакети і генерувати *.deb файли для системної установки simulavr:

```
sudo apt оновлення
sudo apt встановити g++ завантажити плагін - pdf
зробити cfgclean python debian
код товару: dpkg -і build/debian/python3-simulavr*.deb
```

Для компіляції кліппера для використання в simulavr, запустіть:

```
javascript licenses api веб-сайт go1.13.8
налаштування меню
```

і компіляція програмного забезпечення для AVR atmega644p і виберіть підтримку емуляції програмного забезпечення SIMULAVR. Потім можна компілювати Кліппер (біг `make`), а потім почати моделювання з:

```
PYTHONPATH=/path/to/simulavr/build/pysimulavr/ JavaScript licenses API Веб-сайт Go1.13.8
```

Зверніть увагу, що якщо ви встановили python3-simulavr системно-широтою, вам не потрібно встановити `PYTHONPATH`, і може просто запустити тренажер як

```
./scripts/avrsim.py out/ klipper.elf
```

Потім, з simulavr, що працює в іншому вікні, можна запустити наступне, щоб читати gcode з файлу (наприклад, "test.gcode"), обробити його за допомогою Klippy, і відправити його на Klipper, що працює в simulavr (див. [installation](Installation.md) за кроки, необхідні для побудови python віртуального середовища):

```
~/klippy-env/bin/python ./klippy/klippy.py javascript licenses api веб-сайт go1.13.8 -i тест.gcode -р
```

### Використання simulavr з gtkwave

Однією корисною особливістю simulavr є можливість створення файлів генерації сигналів за допомогою точного часу подій. Для цього слідуйте за напрямами вище, але запустіть avrsim.py з командним рядком, як:

```
PYTHONPATH=/path/to/simulavr/src/python/ ./scripts/avrsim.py out/klipper.elf -t PORTA.PORT,PORTC. ПОРТ
```

Надійшла б створити файл **avrsim.vcd** з інформацією про кожну зміну GPIO на PORTA і PORTB. Це можна переглянути за допомогою gtkwave з:

```
Gtkwave avrsim.vcd
```
