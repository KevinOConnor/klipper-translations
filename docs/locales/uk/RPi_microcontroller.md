# Мікроконтролер RPi

Цей документ описує процес запуску Klipper на RPi і використовувати той же RPi як вторинний Mcu.

## Чому використовують RPi як вторинний MCU?

Часто МКУ, присвячені контролінгу 3D-принтерів, мають обмежену і попередньо налаштовану кількість піддаються шпилькам для управління основними функціями друку (термальні резистори, екструдери, крокуси ...). Використання RPi, де Klipper встановлюється як вторинний MCU дає можливість безпосередньо використовувати GPIOs і автобуси (i2c, spi) RPi всередині klipper без використання плагінів Octoprint (якщо використовується) або зовнішніх програм, що дають можливість контролювати всі в межах друку GCODE.

**Налаштування**: Якщо ваша платформа є *Beaglebone* і ви повинні правильно дотримуватися кроків установки, Linux mcu вже встановлена і налаштована для вашої системи.

## Встановіть rc скрипт

Якщо ви хочете використовувати хост як вторинний MCU, процес klipper_mcu повинен працювати перед процесом затискання.

Після установки Кліппер, встановіть скрипт. Запуск:

```
cd ~ / клиппер /
javascript licenses api веб-сайт go1.13.8
sudo systemctl включити klipper-mcu.service
```

## Створення мікроконтролерного коду

Щоб компілювати код мікроконтролера Klipper, запустіть настройку для процесу "Linux":

```
cd ~ / клиппер /
налаштування меню
```

У меню встановіть «Мікроконтролер Архітектура» на «Linux process», потім збережіть і виходите.

Для побудови та встановлення нового мікроконтролюючого коду запустіть:

```
sudo service klipper stop
 зробити спалах
 sudo service klipper start
```

Якщо klippy.log повідомляє про помилку "Попередня відмова" при спробі підключення до `/tmp/klipper_host_mcu`, після чого потрібно додати користувача до групи шин. Наступне командування додасть користувачу "Пі" групі:

```
sudo usermod -a -G tty pi
```

## Конфігурація, що залишилася

Завершіть інсталяцію, налаштувавши вторинний MCU Klipper, дотримуючись інструкцій у [зразок конфігурації RaspberryPi](../config/sample-raspberry-pi.cfg) і [Зразок конфігурації кількох MCU](../config/sample-multi-mcu.cfg).

## Додатково: збірка SPI

Переконайтеся, що драйвер Linux SPI працює `sudo raspi-config` і дозволяє SPI під меню «Інфракційні параметри».

## Додатково: Включення I2C

Переконайтеся, що драйвер Linux I2C ввімкнено за допомогою запуску `sudo raspi-config` і дозволяє I2C під меню «Інфракційні параметри». Якщо планується використовувати I2C для акселерометра МПУ, необхідно також встановити курс на бас до 400000: додавання/розвантаження `dtparam=i2c_arm=on,i2c_arm_baudrate=400000` в `/завантаження/config.txt` (або `/завантаження/підтвердження/config.txt` в деяких дистроях).

## Додатково: Визначте правильний gpiochip

На Малини Пі і на багатьох клонах шпильки, які піддаються GPIO, належать до першого gpiochip. Таким чином, можна використовувати на клиппері, просто, посилаючи їх з назвою `gpio0.n`. Тим не менш, є випадки, в яких відкриті штифти належать gpiochips, крім першого. Наприклад, у випадку деяких моделей OrangePi або якщо використовується Port Expander. У цих випадках корисно використовувати команди для доступу до *Linux GPIO * для перевірки конфігурації.

Щоб встановити *Linux GPIO пристрій персонажа - бінарний* на основі дебеля, як octopi запустити:

```
sudo apt-get встановити gpiod
```

Для перевірки наявного gpiochip-сервера:

```
труси
```

Для перевірки номера шпильки і наявності шпильки:

```
gpioinfo
```

Вибраний шпилька може використовуватися в конфігурації, як `gpiochip<n>/gpio<o>`, де **n** є номер чіпа, як видно `gpiodetect` команди і **o** є номер лінії, виданий`gpioinfo`.

***Попередня:*** тільки gpio позначений як `unused`. Не можна використовувати для *line* для одночасного використання декількох процесів.

Наприклад, на RPi 3B+, де клаппер використовують GPIO20 для перемикача:

```
$ gpiodetect
 gpiochip0 [pinctrl-bcm2835] (54 рядки)
 gpiochip1 [raspberrypi-exp-gpio] (8 рядків)

 $gpioinfo
 gpiochip0 - 54 рядки:
         рядок 0: безіменний невикористаний вхідний активний високий
         рядок 1: безіменний невикористаний вхідний активний високий
         рядок 2: безіменний невикористаний вхідний активний високий
         рядок 3: безіменний невикористаний вхідний активний високий
         рядок 4: безіменний невикористаний вхідний активний високий
         рядок 5: безіменний невикористаний вхідний активний високий
         рядок 6: безіменний невикористаний вхідний активний високий
         рядок 7: безіменний невикористаний вхідний активний високий
         рядок 8: безіменний невикористаний вхідний активний високий
         рядок 9: безіменний невикористаний вхідний активний високий
         рядок 10: безіменний невикористаний вхідний активний високий
         рядок 11: безіменний невикористаний вхід активний-високий
         рядок 12: безіменний невикористаний вхідний активний високий
         рядок 13: безіменний невикористаний вхідний активний високий
         рядок 14: безіменний невикористаний вхідний активний високий
         рядок 15: безіменний невикористаний вхідний активний високий
         рядок 16: безіменний невикористаний вхідний активний високий
         рядок 17: безіменний невикористаний вхідний активний високий
         рядок 18: безіменний невикористаний вхідний активний високий
         рядок 19: безіменний невикористаний вхідний активний високий
         рядок 20: безіменний вихід "klipper" активний високий [використовується]
         рядок 21: безіменний невикористаний вхідний активний високий
         рядок 22: безіменний невикористаний вхідний активний високий
         рядок 23: безіменний невикористаний вхідний активний високий
         рядок 24: безіменний невикористаний вхідний активний високий
         рядок 25: безіменний невикористаний вхідний активний високий
         рядок 26: безіменний невикористаний вхідний активний високий
         рядок 27: безіменний невикористаний вхідний активний високий
         рядок 28: безіменний невикористаний вхід активний-високий
         рядок 29: безіменний вихід "led0" активний-високий [використовується]
         рядок 30: безіменний невикористаний вхідний активний високий
         рядок 31: безіменний невикористаний вхідний активний високий
         рядок 32: безіменний невикористаний вхідний активний високий
         рядок 33: безіменний невикористаний вхідний активний високий
         рядок 34: безіменний невикористаний вхідний активний високий
         рядок 35: безіменний невикористаний вхідний активний високий
         рядок 36: безіменний невикористаний вхідний активний високий
         рядок 37: безіменний невикористаний вхідний активний високий
         рядок 38: безіменний невикористаний вхідний активний високий
         рядок 39: безіменний невикористаний вхідний активний високий
         рядок 40: безіменний невикористаний вхідний активний високий
         рядок 41: безіменний невикористаний вхідний активний високий
         рядок 42: безіменний невикористаний вхідний активний високий
         рядок 43: безіменний невикористаний вхідний активний високий
         рядок 44: безіменний невикористаний вхід активний-високий
         рядок 45: безіменний невикористаний вхідний активний високий
         рядок 46: безіменний невикористаний вхідний активний високий
         рядок 47: безіменний невикористаний вхідний активний високий
         рядок 48: безіменний невикористаний вхідний активний високий
         рядок 49: безіменний невикористаний вхідний активний високий
         рядок 50: безіменний невикористаний вхідний активний високий
         рядок 51: безіменний невикористаний вхідний активний високий
         рядок 52: безіменний невикористаний вхідний активний високий
         рядок 53: безіменний невикористаний вхідний активний високий
 gpiochip1 - 8 рядків:
         рядок 0: безіменний невикористаний вхідний активний високий
         рядок 1: безіменний невикористаний вхідний активний високий
         рядок 2: безіменний вихід "led1" активний низький [використовується]
         рядок 3: безіменний невикористаний вхідний активний високий
         рядок 4: безіменний невикористаний вхідний активний високий
         рядок 5: безіменний невикористаний вхідний активний високий
         рядок 6: безіменний невикористаний вхідний активний високий
         рядок 7: безіменний невикористаний вхідний активний високий
```

## Додатково: Обладнання PWM

Raspberry Pi має два канали PWM (PWM0 і PWM1), які висвітлюються на заголовку або, якщо ні, можуть бути спрямовані на наявні контакти gpio. Демон Linux mcu використовує інтерфейс pwmchip sysfs для керування апаратними пристроями PWM на хостах Linux. Інтерфейс pwm sysfs не надається за замовчуванням на Raspberry, і його можна активувати, додавши рядок до `/boot/config.txt`:

```
# Увімкнути інтерфейс pwmchip sysfs
 dtoverlay=pwm,pin=12,func=4
```

Цей приклад дозволяє тільки PWM0 і маршрути його до gpio12. Якщо обидві канали PWM повинні бути включені, ви можете використовувати `pwm-2chan`:

```
# Увімкнути інтерфейс pwmchip sysfs
 dtoverlay=pwm-2chan,pin=12,func=4,pin2=13,func2=4
```

Цей приклад додатково дозволяє PWM1 і маршрути його до gpio13.

Накладка не виводить лінію рами на сосфах на завантаженні і потрібно експортувати в ехо кількість каналу pwm до `/sys/class/pwmchip0/export`. Це створить пристрій `/sys/class/pwmchip0/pwm0` в файловій системі. Найпростіший спосіб зробити це, додавши до `/etc/rc.local` перед `exit 0` рядок:

```
Нема Увімкнути інтерфейс sysfs pwmchip
echo 0 > /sys/class/pwmchip0/export
```

При використанні як каналів PWM, кількість другого каналу необхідно бути ехо і:

```
Нема Увімкнути інтерфейс sysfs pwmchip
echo 0 > /sys/class/pwmchip0/export
echo 1 > /sys/class/pwmchip0/export
```

За допомогою sysfs на місці ви можете використовувати або канал Pwm (s), додавши наступний шматок конфігурації до вашого `printer.cfg`:

```
[вихід_pin caselight]
шпилька: господар:pwmchip0/pwm0
pwm: Правда
Обладнання_pwm: Про нас
час: 0.000001

[вихід_pin beeper]
шпилька: господар:pwmchip0/pwm1
pwm: Правда
Обладнання_pwm: Про нас
значення: 0
0 товар(ов) - 0.00 €
час: 0.0005
```

Це додасть апаратне управління ромбами до gpio12 і gpio13 на Пі (при використанні накладу було налаштовано до маршруту pwm0 до шпильки=12 і pwm1 для шпильки=13).

PWM0 може бути переданий до gpio12 і gpio18, PWM1 можна відстежити до gpio13 і gpio19:

| ПВМ | христина белла | Панчохи |
| --- | --- | --- |
| 0 р | 12 | 4 |
| 0 р | 18 | 2 |
| 1 | 13 | 4 |
| 1 | 19 | 2 |
