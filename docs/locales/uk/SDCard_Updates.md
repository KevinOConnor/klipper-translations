# Оновлення SDCard

Багато популярних щитів контролера сьогодні корабель з завантажувачем, здатний оновити прошивку через SD-карт. Хоча це зручно в багатьох обставинах, ці завантажувачі зазвичай не забезпечують інший спосіб оновлення прошивки. Це може бути нагота, якщо ваша дошка встановлена в місці, що важко отримати доступ або якщо вам потрібно оновити прошивку часто. Після того, як Klipper спочатку спалахнув на контролер, можна перенести нову прошивку на SD-карту і ініціювати процедуру миття через Ssh.

## Типова процедура оновлення

Процедура оновлення мікропрограми МКУ з використанням SD-карти схожа на інші методи. замість використання `make flash` потрібно запустити скрипт помічника, `flash-sdcard.sh`. Оновлення BigTreeTech SKR 1.3 може виглядати наступним чином:

```
sudo обслуговування klipper стоп
cd ~ / клиппер
git тягнути
Чистий
Налаштування меню
Зроби
JavaScript licenses API Веб-сайт Go1.13.8
sudo сервіс klipper старт
```

Щоб визначити розташування пристрою та назву дошки. Якщо користувач повинен спалахувати декілька дощок, `flash-sdcard.sh` (або `make flash`, якщо це доречно) слід запустити для кожної дошки до перезавантаження сервісу Klipper.

Підтримувані дошки можуть бути вказані з наступним командуванням:

```
javascript licenses api веб-сайт go1.13.8 -л
```

Якщо ви не бачите вашу дошку, вказану вона може бути обов'язково, щоб додати нову дошку, як [описаний нижче](#board-definitions).

## Розширене використання

Наведені вище команди припускають, що ваш MCU з'єднується з частотою за замовчуванням 250000 і прошивкою знаходиться на ` ~/klipper/out/klipper.bin`. `flash-sdcard.sh` скрипт надає параметри для зміни цих за замовчуванням. Всі варіанти можна переглянути за допомогою екрана:

```
JavaScript licenses API Веб-сайт Go1.13.8 -час
SD Card завантажити утиліту для Klipper

Використання: flash_sdcard.sh [-h] [-l] [-c] [-b <baud>] [-f <firmware>]
<device> <board>> <device> <board> <board>><device>>> <board>>>><device>> <board>>>><device>>><device>>> <board>>>>>>>>>>>>>>>>>><device>>>>>>>>>>>>>>>>><device>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>><>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

позиціональні аргументи:
<device> пристрій серійного порту
<board> тип дошки

додаткові аргументи:
-h показати це повідомлення
-l список доступних плат
-c запустіть флеш-перевірку/перевірити тільки (завантажити)
-b <baud> серійний курс шнура (за замовчуванням 250000)
-f <firmware> шлях до клиппера. бін
```

Якщо ваша дошка миготливий з прошивкою, яка з'єднує в користувацькій швидкості baud, можна оновити, вказавши параметр `-b`:

```
JavaScript licenses API Веб-сайт Go1.13.8
```

Якщо ви хочете поспілкуватися з будівництвом Кліппера, розташованого десь, крім розташування за замовчуванням, його можна зробити, вказавши параметр `-f`:

```
JavaScript licenses API Веб-сайт Go1.13.8 JavaScript licenses API Веб-сайт Go1.13.8 /dev/ttyAMA0 btt-skr-v1.3
```

Зауважте, що при модернізації MKS Robin E3 не потрібно вручну запустити `update_mks_robin.py` і постачання отриманого бінарного до `flash-sdcard.sh`. Ця процедура автоматизована в процесі завантаження.

Варіант `-c` використовується для виконання перевірки або перевірки операції для тестування, якщо дошка працює правильно зазначена прошивка. Ця опція призначена для випадків, коли ручна електростанція повинна завершити процедуру миття, такі як завантажувачі, які використовують режим SDIO замість SPI для доступу до своїх SD-карт. (Ше Печери нижче) Але також можна використовувати будь-який час, щоб переконатися, що код, що спалахнув в дошку, відповідає версії в папці вашого будівництва на будь-якій підтриманій дошці.

## Печера

- Як зазначено в впровадженні цей метод працює тільки для оновлення прошивки. Початкова процедура миготіння повинна бути виконана вручну за вказівкою, яка застосовується до вашої плати контролера.
- В той час як можна флешбудувати, що змінює інтерфейс Serial Baud або підключення (тобто: від USB до UART), перевірка завжди не може відключатися до MCU, щоб перевірити точну версію.
- Підтримуються тільки дошки, які використовують SPI для SD-карт. Дошки, які використовують SDIO, такі як Flymaker Flyboard і MKS Robin Nano V1/V2, не будуть працювати в режимі SDIO. Тим не менш, це, як правило, можна спалахувати такі дошки за допомогою програми SPI режим. Але якщо завантажувач дошки використовується тільки режим SDIO для доступу до SD-карти, буде потрібно для того, щоб режим може переключатися з SPI назад до SDIO, щоб завершити рефлешинг. Такі дошки повинні бути визначені `skip_verify`, щоб пропустити контрольний крок відразу після миття. Потім після ручної роботи ви можете перезапустити те ж саме `./scripts/flash-sdcard.sh` команди, але додати `-c` варіант для завершення роботи перевірки/перевірки. Див. [Файлингові дошки, які використовують SDIO](#flashing-boards-that-use-sdio) для прикладів.

## Визначення Правління

Найпоширеніші дошки повинні бути доступні, проте можна додати нове визначення дошки при необхідності. ` ~/klipper/scripts/spi_flash/board_defs.py`. Визначення зберігаються у словнику, наприклад:

```python
BOARD_DEFS = {
'generic-lpc1768': {
'mcu': "lpc1768",
'spi_bus': "ssp1",
"cs_pin": "P0.6"
Головна
...<додаткові визначення>
Про нас
```

Ви можете вказати наступні поля:

- `mcu`: Тип маку. Це може бути відновлено після налаштування збірки через `make менюconfig`, використовуючи `cat .config grep CONFIG_MCU`. Це поле обов'язково.
- `spi_bus`: Автобус SPI підключений до SD-карт. Це повинно бути отримано від схеми дошки. Це поле обов'язково.
- `cs_pin`: Чіп Виберіть шпильку підключений до SD-карт. Це слід отримати з дошки schematic. Це поле обов'язково.
- `firmware_path`: Шлях на SD-карті, де прошивка повинна передаватися. За замовчуванням `firmware.bin`.
- `current_firmware_path`: Шлях на SD-карті, де перейменований файл прошивки знаходиться після вдалого спалаху. За замовчуванням `firmware.cur`.
- `skip_verify`: це визначає логічне значення, яке повідомляє сценаріям пропустити етап перевірки мікропрограми під час процесу прошивки. Типовим значенням є `False`. Його можна встановити на `True` для плат, які потребують ручного циклу живлення для завершення перепрошивки. Щоб згодом перевірити мікропрограму, запустіть сценарій ще раз із опцією `-c`, щоб виконати крок перевірки. [Див. застереження щодо карт SDIO](#caveats)

Якщо програмне забезпечення SPI потрібна, поле `spi_bus` повинна бути встановлена до `swspi` і вказане додаткове поле:

- `spi_pins`: це мають бути 3 контакти, розділені комами, які під’єднані до SD-карти у форматі `miso,mosi,sclk`.

Це має бути надзвичайно рідкісним, що програмне забезпечення SPI є обов'язковим, як правило, тільки дошки з помилками дизайну або дошками, які зазвичай підтримують режим SDIO для своєї SD-карти. `btt-skr-pro` визначення дошки забезпечує приклад колишнього, а `btt-octopus-f446-v1` визначення дошки забезпечує приклад останнього.

Перед створенням нової дошки слід перевірити, чи відповідає існуюча дошка критеріям, необхідні для нової дошки. Якщо це справа, то можна вказати `BOARD_ALIAS`. Наприклад, для уточнення `my-new-board` як псевдонім для `generic-lpc1768`:

```python
BOARD_ALIASES = {
... <previous aliases>,
'my-new-board': BOARD_DEFS['generic-lpc1768'],
Про нас
```

Якщо вам потрібна нова дошка визначення, і ви некомфортний з процедурою, зазначеною вище, рекомендується запитати один в [Klipper Community Discord](Контакт.md#discord).

## Флеш-дошки, які використовують SDIO

[Згадані в печериці](#caveats), дошки, чиї завантажувач використовує режим SDIO для доступу до своєї SD-карти, що вимагає енергетичного циклу дошки, а особливо самої SD-карти, для того, щоб перейти від SPI-режиму, який використовується при написанні файлу до SD-карти назад в режим SDIO для завантажувача, щоб спалахнути його в дошку. Ці визначення дошки будуть використовувати прапор `скіп_verify`, який розповідає про миготливий інструмент, щоб зупинитися після написання прошивки SD-карт так, щоб дошка може бути ручним зарядом і кроком перевірки відкладається до завершення.

Є два сценарії - один з RPi Хост, що працює на окремому електроживленні та інших при RPi Хост працює на одному електропостачанні, як і на головній дошці. Відмінність полягає в тому, чи не потрібно також вимкнути RPi, а потім `ssh` знову після завершення флешки, щоб зробити крок перевірки, або якщо перевірка може бути зроблено відразу. Ось приклади двох сценаріїв:

### ПІО Програмування з RPi на окремому блокі живлення

Типова сесія з RPi на окремому блокі живлення виглядає наступним чином: Ви будете, звичайно, повинні використовувати правильний шлях пристрою і назву дошки:

```
sudo обслуговування klipper стоп
cd ~ / клиппер
git тягнути
Чистий
Налаштування меню
Зроби
JavaScript licenses API Веб-сайт Go1.13.8
[[[[[manually power-cycle]]]]]
JavaScript licenses API Веб-сайт Go1.13.8 -c /dev/ttyACM0 btt-octopus-f446-v1
sudo сервіс klipper старт
```

### ПІО Програмування з RPi на Same Power Supply

Типова сесія з RPi на Same Power Supply виглядає наступним чином: Ви будете, звичайно, повинні використовувати правильний шлях пристрою і назву дошки:

```
sudo обслуговування klipper стоп
cd ~ / клиппер
git тягнути
Чистий
Налаштування меню
Зроби
JavaScript licenses API Веб-сайт Go1.13.8
sudo вимкнення -h тепер
[[[відповіді для РПІ, щоб відхилити, потім знову до РПІ, коли він перезавантажує]]]]]
sudo обслуговування klipper стоп
cd ~ / клиппер
JavaScript licenses API Веб-сайт Go1.13.8 -c /dev/ttyACM0 btt-octopus-f446-v1
sudo сервіс klipper старт
```

У цьому випадку з RPi Хост перезавантажений, який перезавантажить `klipper` сервіс, необхідно зупинити `klipper` знову перед початком перевірки і перезавантажити його після завершення перевірки.

### SDIO до SPI Pin Mapping

Якщо schematic використовує SDIO для своєї SD-карти, ви можете намітити шпильки, як описані в діаграмі нижче, щоб визначити сумісні програми SPI шпильки, щоб призначити в `board_defs.py` файл:

| Сонце Карниз | Мікро SD Карниз | ПІО Ім'я файла | СПИ Ім'я файла |
| :-: | :-: | :-: | :-: |
| 9 | 1 | ДАТА2 | None (ПУ)* |
| 1 | 2 | CD/DATA3 | Р |
| 2 | 3 | КМД | КОШИК |
| 4 | 4 | +3.3В (ВД) | +3.3В (ВД) |
| 5 | 5 | КАРК | СКЛК |
| 3 | 6 | ГНД (ВС) | ГНД (ВС) |
| 7 | 7 | ДАТА0 | МІСО |
| 8 | 8 | ДАТА1 | None (ПУ)* |
| недоступно | 9 | Детект карти (CD) | Детект карти (CD) |
| 6 | 10 | ГНД | ГНД |

\* Ні (ПУ) вказує невикористаний штифт з резистором
